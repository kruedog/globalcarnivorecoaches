<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Manage Coaches ‚Ä¢ Global Carnivore Coaches</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/png" href="/images/earth_steak.png">

  <!-- Fonts (same as index/profile) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">

  <!-- Global site theme -->
  <link rel="stylesheet" href="/css/global.css">
  <!-- Admin layout & components -->
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body class="admin-page">

<header class="admin-header">
  <h1>Manage Coaches</h1>
  <div class="sub">Admin-only view. Edits are written directly to <code>uploads/coaches.json</code>.</div>
  <div class="top-links">
    <a href="/profile.html">‚Üê Back to Profile</a>
    <a href="/">View Site</a>
  </div>
</header>

<main class="admin-main">
  <!-- LEFT: COACH LIST -->
  <section class="card">
    <div class="toolbar">
      <h2 style="margin:0;">Coaches</h2>
      <button type="button" class="btn btn-primary" id="btnNew">Ôºã New Coach</button>
    </div>
    <div id="coachList" class="coach-list">
      Loading coaches‚Ä¶
    </div>
  </section>

  <!-- RIGHT: EDITOR FORM -->
  <section class="card">
    <h2 id="formTitle">Coach Details</h2>
    <form id="coachForm" autocomplete="off">
      <label for="username">Username (unique, login key)</label>
      <input id="username" name="username" required>
      <small class="helper">Used as unique ID. For existing coaches this is locked.</small>

      <label for="coachName">Coach Name (display)</label>
      <input id="coachName" name="coachName">

      <label for="email">Email</label>
      <input id="email" name="email" type="email">

      <label for="role">Role</label>
      <select id="role" name="role">
        <option value="coach">Coach</option>
        <option value="admin">Admin</option>
      </select>
      <small class="helper">Only <strong>Admin</strong> can access this page.</small>

      <!-- Display Order -->
      <label for="displayOrder">Display Order</label>
      <input id="displayOrder" name="displayOrder" type="number" min="1" placeholder="1 = first shown">
      <small class="helper">Controls placement on homepage ‚Äî lower number = top-left.</small>

      <label for="bio">Bio</label>
      <textarea id="bio" name="bio"></textarea>

      <label for="specializations">Specializations</label>
      <textarea id="specializations" name="specializations" placeholder="e.g. Carnivore, Ketovore, Fasting"></textarea>
      <small class="helper">Comma, semicolon, or pipe-separated. Stored as an array in <code>coaches.json</code>.</small>

      <div class="two-cols">
        <div>
          <label for="profile">Profile Image</label>
          <input id="profile" name="profile" placeholder="e.g. coco_123_profile.jpg">
          <small class="helper">Stored as filename only; frontend prefixes <code>/uploads/</code>.</small>
        </div>
        <div>
          <label for="certificate">Certificate Image</label>
          <input id="certificate" name="certificate" placeholder="cert_123.jpg">
        </div>
      </div>

      <div class="two-cols">
        <div>
          <label for="before">Before Photo</label>
          <input id="before" name="before" placeholder="before_123.jpg">
        </div>
        <div>
          <label for="after">After Photo</label>
          <input id="after" name="after" placeholder="after_123.jpg">
        </div>
      </div>

      <label for="tempPassword">Temporary Password (optional reset)</label>
      <input id="tempPassword" name="tempPassword" type="text" placeholder="Set to reset coach password">

      <div class="toolbar" style="margin-top:1rem;">
        <div>
          <button type="submit" class="btn btn-primary" id="btnSave">üíæ Save Coach</button>
          <button type="button" class="btn btn-danger" id="btnDelete" disabled>üóë Delete</button>
        </div>
        <div class="status" id="status"></div>
      </div>
    </form>
  </section>
</main>

<script>
const API_BASE   = window.location.origin + '/webapi/';
const COACHES_URL = '/uploads/coaches.json';
const SAVE_URL    = API_BASE + 'save_coach.php';

let coaches = [];
let currentUsername = null;

// Elements
const coachListEl = document.getElementById('coachList');
const form        = document.getElementById('coachForm');
const statusEl    = document.getElementById('status');
const formTitle   = document.getElementById('formTitle');
const btnNew      = document.getElementById('btnNew');
const btnDelete   = document.getElementById('btnDelete');
const usernameEl  = document.getElementById('username');

function setStatus(msg, ok = true) {
  statusEl.textContent = msg || '';
  statusEl.className = 'status ' + (msg ? (ok ? 'ok' : 'err') : '');
}

// Simple admin check using existing login.php
async function ensureAdmin() {
  try {
    const res = await fetch(API_BASE + 'login.php', {
      method: 'GET',
      credentials: 'include',
      cache: 'no-store'
    });
    const data = await res.json();
    if (!data || !data.success || (data.role || '').toLowerCase() !== 'admin') {
      window.location.href = '/index.html';
      return false;
    }
    return true;
  } catch (err) {
    console.error('Admin check failed', err);
    window.location.href = '/index.html';
    return false;
  }
}

function renderList() {
  if (!coaches.length) {
    coachListEl.innerHTML = '<em>No coaches found.</em>';
    return;
  }

  coachListEl.innerHTML = coaches.map(c => {
    const name  = c.CoachName || c.Username || 'Coach';
    const user  = c.Username || '';
    const role  = (c.Role || 'coach').toUpperCase();
    const order = c.DisplayOrder ? `<span class="badge">#${c.DisplayOrder}</span>` : '';
    const last  = c.last_login ? new Date(c.last_login).toLocaleString() : '';

    return `
      <div class="coach-row" data-username="${user}">
        <div>
          <div class="coach-name">${name}</div>
          <div class="coach-user">@${user}</div>
        </div>
        <div>
          <span class="badge">${role}</span>
          ${order}
          ${last ? `<span class="badge">Last: ${last}</span>` : ''}
        </div>
      </div>`;
  }).join('');

  coachListEl.querySelectorAll('.coach-row').forEach(row => {
    row.addEventListener('click', () => {
      const u = row.getAttribute('data-username');
      selectCoach(u);
    });
  });

  if (currentUsername) {
    const row = coachListEl.querySelector(`[data-username="${currentUsername}"]`);
    if (row) row.classList.add('active');
  }
}

function fillForm(coach) {
  formTitle.textContent = coach ? `Editing: ${coach.CoachName || coach.Username}` : 'New Coach';

  usernameEl.value                        = coach?.Username || '';
  usernameEl.readOnly                     = !!coach?.Username;
  document.getElementById('coachName').value   = coach?.CoachName || '';
  document.getElementById('email').value       = coach?.Email || '';
  document.getElementById('role').value        = (coach?.Role || 'coach').toLowerCase();
  document.getElementById('displayOrder').value = coach?.DisplayOrder || '';

  document.getElementById('bio').value = coach?.Bio || '';

  let specs = '';
  if (Array.isArray(coach?.Specializations)) {
    specs = coach.Specializations.join(', ');
  } else if (typeof coach?.Specializations === 'string') {
    specs = coach.Specializations;
  }
  document.getElementById('specializations').value = specs;

  const files = coach?.Files || {};
  document.getElementById('profile').value     = files.Profile     || '';
  document.getElementById('certificate').value = files.Certificate || '';
  document.getElementById('before').value      = files.Before      || '';
  document.getElementById('after').value       = files.After       || '';

  document.getElementById('tempPassword').value = '';

  btnDelete.disabled = !coach;
}

function selectCoach(username) {
  currentUsername = username;
  const coach = coaches.find(c =>
    (c.Username || '').toLowerCase() === String(username).toLowerCase()
  );

  coachListEl.querySelectorAll('.coach-row').forEach(r => r.classList.remove('active'));
  const activeRow = coachListEl.querySelector(`[data-username="${username}"]`);
  if (activeRow) activeRow.classList.add('active');

  fillForm(coach || null);
  setStatus('');
}

async function loadCoaches() {
  setStatus('Loading coaches‚Ä¶', true);
  try {
    const res  = await fetch(COACHES_URL + '?t=' + Date.now());
    const data = await res.json();
    coaches = Array.isArray(data)
      ? data.sort((a, b) => (a.DisplayOrder ?? 999) - (b.DisplayOrder ?? 999))
      : [];
    renderList();
    setStatus('');
  } catch (err) {
    console.error(err);
    setStatus('Failed to load coaches.json', false);
  }
}

// New coach
btnNew.addEventListener('click', () => {
  currentUsername = null;
  coachListEl.querySelectorAll('.coach-row').forEach(r => r.classList.remove('active'));
  fillForm(null);
  setStatus('');
});

// Save handler
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  setStatus('Saving coach‚Ä¶', true);

  const payload = {
    action: currentUsername ? 'update' : 'create',
    Username:      usernameEl.value.trim(),
    CoachName:     document.getElementById('coachName').value.trim(),
    Email:         document.getElementById('email').value.trim(),
    Role:          document.getElementById('role').value.trim(),
    DisplayOrder:  parseInt(document.getElementById('displayOrder').value) || 999,
    Bio:           document.getElementById('bio').value,
    Specializations: document.getElementById('specializations').value,
    Profile:       document.getElementById('profile').value.trim(),
    Certificate:   document.getElementById('certificate').value.trim(),
    Before:        document.getElementById('before').value.trim(),
    After:         document.getElementById('after').value.trim(),
    TempPassword:  document.getElementById('tempPassword').value
  };

  if (!payload.Username) {
    setStatus('Username is required.', false);
    return;
  }

  try {
    const res = await fetch(SAVE_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify(payload)
    });
    const out = await res.json();

    if (!out.success) {
      setStatus(out.message || 'Save failed.', false);
      return;
    }

    setStatus(out.message || 'Saved.', true);
    await loadCoaches();
    currentUsername = payload.Username;
    selectCoach(currentUsername);
  } catch (err) {
    console.error(err);
    setStatus('Network or server error while saving.', false);
  }
});

// Delete handler
btnDelete.addEventListener('click', async () => {
  const username = usernameEl.value.trim();
  if (!username) return;

  if (!confirm(`Delete coach "${username}"? This cannot be undone.`)) return;

  setStatus('Deleting coach‚Ä¶', true);

  try {
    const res = await fetch(SAVE_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ action: 'delete', Username: username })
    });
    const out = await res.json();

    if (!out.success) {
      setStatus(out.message || 'Delete failed.', false);
      return;
    }

    setStatus('Coach deleted.', true);
    currentUsername = null;
    await loadCoaches();
    fillForm(null);
  } catch (err) {
    console.error(err);
    setStatus('Network or server error while deleting.', false);
  }
});

document.addEventListener('DOMContentLoaded', async () => {
  const ok = await ensureAdmin();
  if (!ok) return;
  await loadCoaches();
});
</script>
</body>
</html>
