<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Admin • Global Carnivore Coaches</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
<style>
  :root{--red:#C51230;--dark:#121212;--light:#f8f9fa;--gray:#333;--card:#ffffff;--border:#e0e0e0}
  body.dark{--card:#1e1e1e;--border:#333;--light:#121212}
  body{margin:0;font-family:'Inter',sans-serif;background:var(--light);color:#000;transition:.3s;color-scheme:light dark}
  body.dark{color:#eee}
  header{background:var(--red);color:white;padding:1.5rem;text-align:center;box-shadow:0 4px 20px rgba(197,18,48,.3)}
  h1{font-family:'Cinzel',serif;font-size:2.8rem;margin:0}
  main{max-width:1400px;margin:2rem auto;padding:0 1rem;display:grid;gap:2rem;grid-template-columns:repeat(auto-fit,minmax(380px,1fr))}
  .card{background:var(--card);border-radius:16px;padding:1.8rem;box-shadow:0 8px 30px rgba(0,0,0,.08);border:1px solid var(--border)}
  body.dark .card{box-shadow:0 8px 30px rgba(0,0,0,.4)}
  .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1.5rem}
  .stat{background:var(--red);color:white;padding:1.5rem;border-radius:12px;text-align:center}
  .stat.big{font-size:3.2rem;font-weight:700;margin:0.4rem 0}
  .controls{margin:2rem 0;display:flex;gap:1rem;flex-wrap:wrap}
  .btn{padding:.9rem 1.8rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:.3s}
  .btn-primary{background:var(--red);color:white}
  .btn-outline{border:2px solid var(--red);background:transparent;color:var(--red)}
  .btn-outline:hover{background:var(--red);color:white}
  canvas{height:300px !important}
  #themeToggle{position:fixed;top:1rem;right:1rem;background:none;border:none;font-size:2rem;cursor:pointer;z-index:100}
  .activity-item{display:flex;align-items:center;gap:1rem;padding:1rem 0;border-bottom:1px solid var(--border)}
  .activity-icon{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;font-weight:bold;color:white;font-size:1.1rem}
  .logout{position:absolute;top:1.5rem;left:1.5rem;color:white;text-decoration:none;font-weight:600}
  .logout:hover{text-decoration:underline}
</style>
</head>
<body>
<a href="/webapi/login.html" onclick="localStorage.clear()" class="logout">Logout</a>
<button id="themeToggle">Dark Mode</button>

<header>
  <h1>Global Carnivore Coaches — Admin</h1>
  <p id="welcome">Welcome back, <strong>Admin</strong></p>
</header>

<main>
  <!-- KEY STATS -->
  <div class="card">
    <h2>Key Metrics</h2>
    <div class="stat-grid">
      <div class="stat"><div class="stat big" id="today">0</div><div>Visitors Today</div></div>
      <div class="stat"><div class="stat big" id="week">0</div><div>This Week</div></div>
      <div class="stat"><div class="stat big" id="total">0</div><div>All Time</div></div>
      <div class="stat"><div class="stat big" id="loginsToday">0</div><div>Coach Logins Today</div></div>
    </div>
  </div>

  <!-- VISITORS CHART -->
  <div class="card">
    <h2>Visitors Last 14 Days</h2>
    <canvas id="visitorChart"></canvas>
  </div>

  <!-- CONTROLS -->
  <div class="card">
    <h2>Quick Actions</h2>
    <div class="controls">
      <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
      <button class="btn btn-primary" onclick="exportXLSX()">Export Excel</button>
      <button class="btn btn-outline" onclick="location.href='/webapi/profile.html'">Edit My Profile</button>
      <button class="btn btn-outline" onclick="resetAll()">Reset All Data</button>
    </div>
  </div>

  <!-- LIVE ACTIVITY FEED -->
  <div class="card">
    <h2>Live Activity Feed</h2>
    <div id="activityFeed">Loading real-time events...</div>
  </div>

  <!-- COACH LIST -->
  <div class="card">
    <h2>Active Coaches</h2>
    <div id="coachList">Loading...</div>
  </div>
</main>

<script>
const API = '/webapi/webapi.php';
let visitorChart;

// Theme
if (localStorage.getItem('dark')==='yes') document.body.classList.add('dark');
document.getElementById('themeToggle').textContent = document.body.classList.contains('dark')?'Light Mode':'Dark Mode';
document.getElementById('themeToggle').onclick=()=>{document.body.classList.toggle('dark');localStorage.setItem('dark',document.body.classList.contains('dark')?'yes':'no');};

// Real-time feed
let es = new EventSource('/webapi/notify.php');
es.onmessage = e => {
  const d = JSON.parse(e.data);
  addActivity(d.coach||d.username, d.action.replace(/_/g,' '), d.details||d.location, d.color||'#666');
};

// Helpers
async function get(url){try{const r=await fetch(url+'&t='+Date.now());return r.ok?await r.json():null}catch(e){return null;}}

function addActivity(name, action, details, color){
  const feed = document.getElementById('activityFeed');
  const div = document.createElement('div');
  div.className = 'activity-item';
  div.innerHTML = `
    <div class="activity-icon" style="background:${color}">${action[0]}</div>
    <div><strong>${name}</strong> ${action}</strong><br><small>${details||''}</small></div>
    <div style="margin-left:auto;font-size:.9rem;opacity:.8">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
  feed.prepend(div);
 10 items only
  if (feed.children.length>30) feed.removeChild(feed.lastChild);
}

// Load everything
async function load(){
  const stats = await get(API+'?action=get_stats');
  if(stats){
    document.getElementById('today').textContent = stats.today||0;
    document.getElementById('week').textContent = stats.week||0;
    document.getElementById('total').textContent = stats.total||0;
    document.getElementById('loginsToday').textContent = stats.loginsToday||0;
  }

  // Visitor chart
  const visits = await get(API+'?action=get_visits_14days');
  if(visits && !visitorChart){
    new Chart(document.getElementById('visitorChart'),{
      type:'line',
      data:{datasets:[{label:'Daily Visitors',data:visits,borderColor:'#C51230',backgroundColor:'rgba(197,18,48,.2)',tension:.3,fill:true}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{type:'time',time:{unit:'day'}}}}
    });
  }

  // Coach list
  const coaches = await get(API+'?action=get_coaches');
  const list = document.getElementById('coachList');
  if(coaches?.length){
    list.innerHTML = coaches.map(c=>`<div style="padding:.8rem 0;border-bottom:1px solid #eee"><strong>${c.CoachName||c.Username}</strong> — last seen ${c.last_login||'never'}</div>`).join('');
  }else list.innerHTML = '<em>No coaches yet</em>';
}

load();
setInterval(load,15000);
</script>
</body>
</html>