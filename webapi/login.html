<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coach Login | Global Carnivore Coaches</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora&display=swap" rel="stylesheet">

<style>
:root {
    --primary:#C51230;
    --accent:#192168;
}
body {
    font-family:'Lora',serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color:var(--accent);
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:2rem;
}
.container {
    max-width:420px;
    width:100%;
    background:#fff;
    padding:2rem;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.15);
    border:2px solid var(--accent);
}
h2 {
    font-family:'Cinzel',serif;
    color:var(--primary);
    text-align:center;
    margin:0 0 1.5rem;
    font-size:1.8rem;
}
input[type=text], input[type=password] {
    width:100%;
    padding:.9rem;
    margin:0.6rem 0;
    border:1px solid var(--accent);
    border-radius:6px;
    font-size:1rem;
    box-sizing:border-box;
}
button {
    width:100%;
    padding:.9rem;
    background:var(--primary);
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-family:'Cinzel',serif;
    font-size:1.1rem;
    margin-top:0.8rem;
}
button:hover { background:#a10e28; }
#homeBtn {
    background:var(--accent);
    margin-top:0.4rem;
}
#homeBtn:hover { background:#0d123b; }
#loginMsg {
    margin-top:1rem;
    text-align:center;
    min-height:1.4em;
    font-weight:bold;
}

/* Modal */
#agreementModal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter:blur(4px);
}
.modal-box {
    background:#fff;
    width:95%;
    max-width:620px;
    max-height:85vh;
    overflow-y:auto;
    padding:2rem;
    border-radius:12px;
    border:3px solid var(--primary);
    box-shadow:0 15px 40px rgba(0,0,0,0.3);
}
.modal-box h3 {
    font-family:'Cinzel',serif;
    color:var(--primary);
    text-align:center;
    font-size:1.7rem;
    margin-top:0;
}
.modal-box label {
    display:block;
    margin:1.2rem 0;
    font-size:1.05rem;
}
.modal-box a {
    color:var(--primary);
    text-decoration:underline;
}
.modal-actions {
    margin-top:2rem;
    text-align:right;
}
.modal-actions button {
    width:auto;
    padding:0.7rem 1.5rem;
    margin-left:0.8rem;
}
#cancelAgree { background:#666; }
</style>
</head>
<body>

<div class="container">
  <h2>Coach Login</h2>

  <form id="loginForm" autocomplete="off">
    <input type="text" id="username" placeholder="Username" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit">Login</button>
    <button type="button" id="homeBtn">Home</button>
  </form>

  <div id="loginMsg">div>
</div>

<!-- AGREEMENT MODAL -->
<div id="agreementModal">
  <div class="modal-box">
    <h3>Important – Please Read & Accept</h3>
    <p>Before accessing your coach dashboard for the first time, you must review and agree to our legal policies:</p>

    <label>
      <input type="checkbox" id="agreeTOS">
      I have read and agree to the <a href="legal.html" target="_blank">Terms of Service</a>
    </label>

    <label>
      <input type="checkbox" id="agreePrivacy">
      I have read and agree to the <a href="legal.html" target="_blank">Privacy Policy</a>
    </label>

    <label>
      <input type="checkbox" id="agreePhotos">
      I have read and agree to the <a href="legal.html" target="_blank">Photo Upload & Media Policy</a>
    </label>

    <div class="modal-actions">
      <button id="cancelAgree">Cancel</button>
      <button id="confirmAgree">Accept & Continue</button>
    </div>
  </div>
</div>

<script>
// login.php & accept_terms.php are in the same folder as this file
const API_BASE = '';

const form = document.getElementById('loginForm');
const loginMsg = document.getElementById('loginMsg');
let pendingUsername = null;

form.addEventListener('submit', async e => {
  e.preventDefault();
  loginMsg.textContent = '';
  loginMsg.style.color = 'red';

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  if (!username || !password) {
    loginMsg.textContent = 'Enter username and password';
    return;
  }

  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = 'Logging in…';

  try {
    const res = await fetch(`${API_BASE}login.php`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const json = await res.json();

    if (json.requireAgreement === true) {
      pendingUsername = json.username;
      document.getElementById('agreementModal').style.display = 'flex';
      btn.disabled = false;
      btn.textContent = 'Login';
      return;
    }

    if (json.success) {
      localStorage.setItem('username', json.username);
      localStorage.setItem('coachName', json.coachName || json.username);
      localStorage.setItem('email', json.email || '');
      window.location.href = 'profile.html';
      return;
    }

    loginMsg.textContent = json.message || 'Login failed';

  } catch (err) {
    loginMsg.textContent = 'Connection error';
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Login';
  }
});

document.getElementById('homeBtn').onclick = () => location.href = '/index.html';

document.getElementById('cancelAgree').onclick = () => {
  document.getElementById('agreementModal').style.display = 'none';
};

document.getElementById('confirmAgree').onclick = async () => {
  const tos = document.getElementById('agreeTOS').checked;
  const privacy = document.getElementById('agreePrivacy').checked;
  const photos = document.getElementById('agreePhotos').checked;

  if (!tos || !privacy || !photos) {
    alert('You must agree to all three policies.');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}accept_terms.php`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: pendingUsername })
    });

    const result = await res.json();

    if (!result.success) {
      alert('Error: ' + (result.message || 'Failed'));
      return;
    }

    // SUCCESS → LOG IN
    localStorage.setItem('username', pendingUsername);
    localStorage.setItem('coachName', pendingUsername);

    loginMsg.style.color = '#006400';
    loginMsg.textContent = 'Welcome! Redirecting…';

    setTimeout(() => window.location.href = 'profile.html', 800);

  } catch (err) {
    alert('Network error');
  }
};
</script>

</body>
</html>