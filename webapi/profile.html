<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coach Profile • Global Carnivore Coaches</title>
<link rel="icon" type="image/png" href="/images/earth_steak.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --white:#fff; --parch:#D0D2D5; --text:#192168; --blue:#192168; --red:#AF1E2D; --muted:#555;
  --shadow:0 12px 40px rgba(0,0,0,.22); --radius:14px; --glass:rgba(255,255,255,.75);
}
*{box-sizing:border-box;margin:0;padding:0}
body{min-height:100vh;font-family:'Inter',sans-serif;background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,var(--parch) 40%,#B0B3BA 100%);color:var(--text);padding:2rem 1rem;line-height:1.6}
.wrap{max-width:1160px;margin:auto}
h1{font-family:'Cinzel',serif;font-size:2.7rem;color:var(--blue);text-align:center;margin-bottom:.4rem}
.lead{text-align:center;color:var(--muted);font-size:1.15rem;margin-bottom:2.4rem}
.card{background:var(--glass);backdrop-filter:blur(16px);padding:2.4rem;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:2rem;border:1px solid rgba(255,255,255,.4)}
label{font-weight:600;margin-bottom:.6rem;display:block;color:var(--blue)}
.form-grid{display:grid;gap:1.4rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
input,textarea{width:100%;padding:1rem 1.1rem;border:2px solid var(--blue);border-radius:var(--radius);background:#fff;font-size:1rem;transition:border .3s,box-shadow .3s}
input:focus,textarea:focus{border-color:var(--red);outline:none;box-shadow:0 0 0 4px rgba(175,30,45,.15)}
textarea{resize:vertical;min-height:140px}
.btn{padding:.9rem 2.4rem;font-weight:700;border:none;border-radius:999px;cursor:pointer;font-size:1rem;transition:all .3s;margin:.25rem .4rem;display:inline-block}
.btn-primary{background:var(--red);color:#fff;box-shadow:0 8px 25px rgba(175,30,45,.35)}
.btn-secondary{background:transparent;border:2px solid var(--blue);color:var(--blue)}
.btn-primary:hover{background:#8b1624;transform:translateY(-2px)}
.btn-secondary:hover{background:var(--blue);color:#fff}
.upload-zone{border:3px dashed var(--blue);padding:2rem 1.4rem;text-align:center;cursor:pointer;border-radius:var(--radius);background:rgba(25,33,104,.05);transition:all .3s;font-weight:600;color:var(--blue);font-size:.95rem}
.upload-zone:hover{border-color:var(--red);background:rgba(175,30,45,.08)}
.upload-zone.dragover{background:rgba(175,30,45,.15);border-color:var(--red)}
#uploadsList{margin-top:2rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1.4rem}
.preview-item{position:relative;overflow:hidden;border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.15);background:#000}
.preview-img{width:100%;height:220px;object-fit:cover}
.preview-caption{background:rgba(25,33,104,.88);color:#fff;padding:.8rem;font-weight:600;text-align:center;position:absolute;bottom:0;width:100%;font-size:.9rem}
.remove-btn{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;width:32px;height:32px;border-radius:50%;border:none;font-size:1.3rem;line-height:1;cursor:pointer;z-index:5}
.specializations-list{margin-top:.7rem;display:flex;flex-wrap:wrap;gap:.6rem}
.specializations-list span{background:var(--red);color:#fff;padding:.35rem .9rem;border-radius:20px;font-size:.9rem;font-weight:600;cursor:pointer}
.footer-actions{text-align:center;margin-top:2rem}

/* MODAL */
#publicProfileModal{position:fixed;inset:0;background:rgba(25,33,104,.97);display:none;align-items:center;justify-content:center;padding:2rem;z-index:9999}
.modal-shell{background:var(--glass);border:6px solid var(--red);border-radius:28px;max-width:1500px;width:100%;max-height:96vh;overflow:hidden;position:relative;box-shadow:0 40px 100px rgba(0,0,0,.6);display:flex;flex-direction:column}
.modal-close{position:absolute;top:1.8rem;right:2.5rem;font-size:3rem;color:#ddd;text-decoration:none;z-index:10;transition:.3s;line-height:1}
.modal-close:hover{color:#fff;transform:scale(1.08)}
.modal-header{text-align:left;padding:2.5rem 4rem 0}
.modal-header h2{font-family:'Cinzel',serif;font-size:2.4rem;color:var(--red)}
.modal-body{display:grid;grid-template-columns:1.1fr .9fr;gap:3.5rem;padding:0 4rem 2.5rem;overflow-y:auto}
.profile-avatar{position:absolute;top:2.2rem;right:5rem;width:220px;height:220px;border:8px solid var(--red);border-radius:50%;overflow:hidden;background:#000;box-shadow:0 25px 70px rgba(0,0,0,.65)}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.bio-box{background:#fff;border:5px solid var(--red);border-radius:var(--radius);padding:2rem 2.5rem;max-height:420px;overflow-y:auto;box-shadow:inset 0 8px 25px rgba(175,45,.16)}
.before-after{display:flex;gap:1.8rem;flex-wrap:wrap}
.ba-pair img{width:210px;height:300px;object-fit:cover;border-radius:18px;border:6px solid var(--red);background:#000}
.specialization-box{background:#fff;border:4px solid var(--red);border-radius:var(--radius);padding:1rem 1.4rem;width:320px;max-width:100%;max-height:160px;overflow-y:auto;text-align:center}
#certificateContainer img{max-width:260px;border:4px solid var(--red);border-radius:12px;box-shadow:0 14px 45px rgba(0,0,0,.5)}
.book-btn-fixed{position:absolute;bottom:1.8rem;right:3.5rem;background:var(--red);color:#fff;padding:1rem 3.2rem;font-size:1.2rem;font-weight:800;border-radius:999px;border:none;cursor:pointer;box-shadow:0 22px 65px rgba(175,45,.65)}
</style>
</head>

<body>
<div class="wrap">
  <h1>Coach Profile</h1>
  <p class="lead">Welcome back, <strong id="coachName">Coach</strong>.</p>

  <div class="card">
    <form id="profileForm" enctype="multipart/form-data">
      <div class="form-grid">
        <div><label>Full Name</label><input id="coachNameInput" required></div>
        <div><label>Email</label><input id="email" type="email"></div>
        <div><label>Phone</label><input id="phone"></div>
      </div>

      <div style="margin-top:1.8rem"><label>Bio</label><textarea id="bio"></textarea></div>

      <div style="margin-top:1.8rem">
        <label>Specializations</label>
        <div style="display:flex;gap:1rem;margin-bottom:.5rem;flex-wrap:wrap">
          <input type="text" id="newSpec" placeholder="Add specialization..." style="flex:1;min-width:220px">
          <button type="button" class="btn btn-primary add-spec-btn">Add</button>
        </div>
        <div class="specializations-list" id="specList"></div>
      </div>

      <div class="form-grid" style="margin-top:2rem">
        <div><label>Profile Photo</label><div class="upload-zone" id="profileUpload">Drop or click</div></div>
        <div><label>Before Photo</label><div class="upload-zone" id="beforeUpload">Drop or click</div></div>
        <div><label>After Photo</label><div class="upload-zone" id="afterUpload">Drop or click</div></div>
        <div><label>Certification</label><div class="upload-zone" id="certUpload">Drop or click</div></div>
      </div>

      <div id="uploadsList"></div>

      <div class="footer-actions">
	  <button type="submit" class="btn" id="saveBtn">Save Changes</button>
	  <button type="button" class="btn ghost" id="viewProfileBtn">Preview Public Profile</button>
	</div>

	<!-- New dashboard / admin buttons -->
	<div class="footer-actions" style="margin-top:1rem;">
	  <button type="button" class="btn" id="dashboardBtn">View Visitor Dashboard</button>
	  <button type="button" class="btn ghost" id="manageCoachesBtn" style="display:none;">
		Manage Coaches (Admin)
	  </button>
	</div>

<div style="text-align:center;margin-top:1rem">
  <button class="btn" id="logoutBtn" type="button">Logout</button>
</div>

<!-- PUBLIC PROFILE MODAL -->
<div id="publicProfileModal">
  <div class="modal-shell">
    <a href="#" class="modal-close" id="closeModal">×</a>
    <div class="modal-header">
      <h2 id="modalName">Coach</h2>
      <p><a id="modalEmail" style="color:var(--red);text-decoration:none;font-weight:bold;"></a></p>
      <div class="profile-avatar"><img id="modalProfilePic" src="/images/earth_steak.png"></div>
    </div>
    <div class="modal-body">
      <div>
        <div class="bio-box" id="modalBio"></div>
        <div class="before-after" id="beforeAfterContainer"></div>
      </div>
      <div class="right-column">
        <div class="specialization-box"><h3>I Specialize In</h3><ul id="specializationList"></ul></div>
        <div id="certificateContainer"></div>
      </div>
    </div>
    <button class="book-btn-fixed">Book This Coach</button>
  </div>
</div>

<script>
const API_BASE = window.location.origin + '/webapi/';
let currentCoach = {};
let specializations = [];
const newFiles = new Map();   // {Profile: File, Before: File, ...}
const pendingDeletes = new Set();

function imgUrl(file) {
  // load from persistent disk
  return `/uploads/${file}?v=${Date.now()}`;
}

// ---------------- LOAD PROFILE -------------------
async function loadProfile() {
  const username = localStorage.getItem('username');
  if (!username) {
    location.href = '/webapi/login.html';
    return;
  }

  const res = await fetch(`${API_BASE}get_coach.php?username=${username}`, {cache:'no-store'});
  const data = await res.json();
  if (!data.success) {
    alert("Failed to load profile"); 
    return;
  }

  currentCoach = data.coach;

  document.getElementById('coachName').textContent     = currentCoach.CoachName || currentCoach.Username;
  document.getElementById('coachNameInput').value      = currentCoach.CoachName || '';
  document.getElementById('email').value               = currentCoach.Email || '';
  document.getElementById('phone').value               = currentCoach.Phone || '';
  document.getElementById('bio').value                 = currentCoach.Bio || '';

  specializations =
    Array.isArray(currentCoach.Specializations) ?
    [...currentCoach.Specializations] : [];
  renderSpecializations();
  renderImages();
}

// ---------------- SPECIALIZATIONS -----------------
function renderSpecializations() {
  const list = document.getElementById('specList');
  list.innerHTML = '';
  specializations.forEach((s,i)=>{
    const tag = document.createElement('span');
    tag.textContent = s;
    tag.onclick = () => {specializations.splice(i,1);renderSpecializations();};
    list.appendChild(tag);
  });
}

document.querySelector('.add-spec-btn').onclick = () => {
  const inp = document.getElementById('newSpec');
  const v = inp.value.trim();
  if (v && !specializations.includes(v)) {
    specializations.push(v);
    renderSpecializations();
  }
  inp.value = '';
};

// ---------------- IMAGES - RENDER EXISTING --------
function renderImages() {
  const list = document.getElementById('uploadsList');
  list.innerHTML = '';
  const labels = {Profile:'Profile',Before:'Before',After:'After',Certificate:'Certificate'};
  if (!currentCoach.Files) return;

  for (const [slot,file] of Object.entries(currentCoach.Files)) {
    if (!file) continue;
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${imgUrl(file)}" class="preview-img">
      <div class="preview-caption">${labels[slot]}</div>
      <button class="remove-btn" data-slot="${slot}">×</button>`;
    div.querySelector('.remove-btn').onclick = ()=>{
      pendingDeletes.add(slot);
      div.remove();
    };
    list.appendChild(div);
  }
}

// ---------------- IMAGES - NEW UPLOADS -------------
function setupUploader(zoneId, slot) {
  const zone = document.getElementById(zoneId);
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';

  input.onchange = ()=>{
    if (input.files[0]) {
      newFiles.set(slot, input.files[0]);
      pendingDeletes.delete(slot);
      previewTemp(slot, input.files[0]);
    }
  };

  zone.onclick = ()=> input.click();
}

function previewTemp(slot, file) {
  const list = document.getElementById('uploadsList');
  const div = document.createElement('div');
  div.className = 'preview-item';
  
  const reader = new FileReader();
  reader.onload = (e)=>{
    div.innerHTML = `
      <img src="${e.target.result}" class="preview-img">
      <div class="preview-caption">${slot}</div>
      <button class="remove-btn" data-slot="${slot}">×</button>`;
    div.querySelector('.remove-btn').onclick = ()=>{
      newFiles.delete(slot);
      div.remove();
    };
    list.appendChild(div);
  };
  reader.readAsDataURL(file);
}

// Register uploaders
setupUploader('profileUpload', 'Profile');
setupUploader('beforeUpload', 'Before');
setupUploader('afterUpload', 'After');
setupUploader('certUpload', 'Certificate');

// ---------------- SAVE -----------------
document.getElementById('profileForm').onsubmit = async (e)=>{
  e.preventDefault();
  const username = localStorage.getItem('username');
  if (!username) return;

  const form = new FormData();
  form.append('username', username);
  form.append('coachName', document.getElementById('coachNameInput').value.trim());
  form.append('email', document.getElementById('email').value.trim());
  form.append('phone', document.getElementById('phone').value.trim());
  form.append('bio', document.getElementById('bio').value);

  form.append('specializations', JSON.stringify(specializations));

  newFiles.forEach((file,slot)=> form.append(`files[${slot}]`, file));
  pendingDeletes.forEach(slot => form.append('DeleteFile', slot));

  const r = await fetch(`${API_BASE}update_coach.php`, {method:'POST', body:form});
  const data = await r.json();

  if (!data.success) {
    alert("Save failed: " + data.message);
    return;
  }

  newFiles.clear();
  pendingDeletes.clear();
  await loadProfile();
  alert("Saved!");
};

// ---------------- MODAL PREVIEW -----------------
document.getElementById('viewProfileBtn').onclick = () => {
  if (!currentCoach.Files) return;

  document.getElementById('modalName').textContent = currentCoach.CoachName;
  const email = currentCoach.Email || '';
  const link = document.getElementById('modalEmail');
  link.textContent = email;
  link.href = email ? `mailto:${email}` : '#';

  const p = document.getElementById('modalProfilePic');
  p.src = currentCoach.Files.Profile ? imgUrl(currentCoach.Files.Profile) : '/images/earth_steak.png';

  const bioBox = document.getElementById('modalBio');
  bioBox.innerHTML = '';
  (currentCoach.Bio||'').split(/\n+/).forEach(t=>{
    if(t.trim()){
      const el = document.createElement('p');
      el.textContent = t;
      bioBox.appendChild(el);
    }
  });

  const ba = document.getElementById('beforeAfterContainer');
  ba.innerHTML = '';
  ['Before','After'].forEach(slot=>{
    const file = currentCoach.Files[slot];
    if(!file) return;
    const wrap=document.createElement('div');
    wrap.className='ba-pair';
    const img=document.createElement('img');
    img.src = imgUrl(file);
    wrap.appendChild(img);
    ba.appendChild(wrap);
  });

  const sl=document.getElementById('specializationList');
  sl.innerHTML='';
  specializations.forEach(s=>{
    const li=document.createElement('li');
    li.textContent=s;
    sl.appendChild(li);
  });

  const cert=document.getElementById('certificateContainer');
  cert.innerHTML='';
  if(currentCoach.Files.Certificate){
    const img=document.createElement('img');
    img.src=imgUrl(currentCoach.Files.Certificate);
    cert.appendChild(img);
  }

  document.getElementById('publicProfileModal').style.display='flex';
};

document.getElementById('closeModal').onclick = (e)=>{
  e.preventDefault();
  document.getElementById('publicProfileModal').style.display='none';
};

document.getElementById('logoutBtn').onclick = ()=>{
  localStorage.clear();
  fetch(`${API_BASE}logout.php`).finally(()=>{
    location.href='/webapi/login.html';
  });
};

loadProfile();

<script>
// ... your existing script above ...

// Existing preview handler is here:
// document.getElementById('viewProfileBtn').onclick = () => { ... };

// === New: Visitor dashboard (all coaches) ===
const dashBtn = document.getElementById('dashboardBtn');
if (dashBtn) {
  dashBtn.addEventListener('click', () => {
    window.location.href = '/webapi/visitor_dashboard.html';
  });
}

// === New: Manage coaches (Admins only) ===
const manageBtn = document.getElementById('manageCoachesBtn');

async function initAdminButton() {
  if (!manageBtn) return;
  try {
    const res = await fetch(API_BASE + 'login.php', {
      method: 'GET',
      credentials: 'include',
      cache: 'no-store'
    });
    if (!res.ok) return;
    const info = await res.json();
    if (info && info.success && (info.role || '').toLowerCase() === 'admin') {
      manageBtn.style.display = 'inline-flex';
      manageBtn.addEventListener('click', () => {
        window.location.href = '/webapi/manage_coaches.html';
      });
    }
  } catch (err) {
    console.warn('Could not determine role for admin button', err);
  }
}

initAdminButton();
</script>


</body>
</html>
