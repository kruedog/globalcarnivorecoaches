<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Coach Profile • Global Carnivore Coaches</title>
  <link rel="icon" type="image/png" href="/public/images/earth_steak.png">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --white:#fff;--parch:#D0D2D5;--text:#192168;--blue:#192168;--red:#AF1E2D;--muted:#555;
      --shadow:0 12px 40px rgba(0,0,0,.22);--radius:14px;--glass:rgba(255,255,255,.75);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;font-family:'Inter',sans-serif;
      background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,var(--parch) 40%,#B0B3BA 100%);
      color:var(--text);padding:2rem 1rem;line-height:1.6;
    }
    .wrap{max-width:1160px;margin:auto}
    h1{font-family:'Cinzel',serif;font-size:2.4rem;color:var(--blue);text-align:center;margin-bottom:.4rem;}
    .lead{text-align:center;color:var(--muted);font-size:1.05rem;margin-bottom:2rem}
    .card{
      background:var(--glass);backdrop-filter:blur(16px);
      padding:2.4rem;border-radius:var(--radius);box-shadow:var(--shadow);
      margin-bottom:2rem;border:1px solid rgba(255,255,255,.4);
    }
    label{font-weight:600;margin-bottom:.4rem;display:block;color:var(--blue);}
    .form-grid{display:grid;gap:1.4rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
    input,textarea{
      width:100%;padding:.85rem 1rem;border:2px solid var(--blue);border-radius:var(--radius);
      background:#fff;font-size:.96rem;transition:border .2s,box-shadow .2s;
    }
    input:focus,textarea:focus{border-color:var(--red);outline:none;box-shadow:0 0 0 3px rgba(175,30,45,.18);}
    textarea{resize:vertical;min-height:140px}
    .btn{
      padding:.8rem 2.3rem;font-weight:700;border:none;border-radius:999px;
      cursor:pointer;font-size:.95rem;transition:all .2s;margin:.25rem .35rem;display:inline-block;
    }
    .btn-primary{background:var(--red);color:#fff;box-shadow:0 8px 24px rgba(175,30,45,.35);}
    .btn-primary:hover{background:#8b1624;transform:translateY(-1px)}
    .btn-ghost{background:transparent;border:2px solid var(--blue);color:var(--blue);}
    .btn-ghost:hover{background:var(--blue);color:#fff}
    .upload-zone{
      border:3px dashed var(--blue);padding:2rem 1.2rem;text-align:center;
      cursor:pointer;border-radius:var(--radius);background:rgba(25,33,104,.05);
      transition:all .2s;font-weight:600;color:var(--blue);font-size:.9rem;
    }
    .upload-zone:hover{border-color:var(--red);background:rgba(175,30,45,.08)}
    #uploadsList{margin-top:2rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1.4rem;}
    .preview-item{position:relative;overflow:hidden;border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.15);background:#000;}
    .preview-img{width:100%;height:220px;object-fit:cover}
    .preview-caption{background:rgba(25,33,104,.9);color:#fff;padding:.6rem;font-weight:600;text-align:center;position:absolute;bottom:0;width:100%;font-size:.85rem;}
    .remove-btn{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;width:30px;height:30px;border-radius:50%;border:none;font-size:1.2rem;cursor:pointer;z-index:5;}
    .specializations-list{margin-top:.7rem;display:flex;flex-wrap:wrap;gap:.6rem;}
    .specializations-list span{background:var(--red);color:#fff;padding:.35rem .9rem;border-radius:20px;font-size:.9rem;font-weight:600;cursor:pointer;}
    .status-line{text-align:center;font-size:.9rem;margin-top:.7rem;min-height:1rem;}
    .status-line.ok{color:green}.status-line.err{color:var(--red)}
    /* MODAL */
    #publicProfileModal{position:fixed;inset:0;background:rgba(25,33,104,.97);display:none;align-items:center;justify-content:center;padding:2rem;z-index:9999;}
    .modal-shell{background:var(--glass);border:6px solid var(--red);border-radius:28px;max-width:1500px;width:100%;max-height:96vh;overflow:hidden;position:relative;box-shadow:0 40px 100px rgba(0,0,0,.6);display:flex;flex-direction:column;}
    .modal-close{position:absolute;top:1.8rem;right:2.5rem;font-size:3rem;color:#ddd;border:none;background:none;cursor:pointer;line-height:1;}
    .modal-close:hover{color:#fff;transform:scale(1.08)}
    .modal-header{text-align:left;padding:2.5rem 4rem 0;}
    .modal-body{display:grid;grid-template-columns:1.1fr .9fr;gap:3.5rem;padding:0 4rem 2.5rem;overflow-y:auto;}
    .profile-avatar{position:absolute;top:2.2rem;right:5rem;width:220px;height:220px;border:8px solid var(--red);border-radius:50%;overflow:hidden;background:#000;box-shadow:0 25px 70px rgba(0,0,0,.65);}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}
    .book-btn-fixed{position:absolute;bottom:1.8rem;right:3.5rem;background:var(--red);color:#fff;padding:1rem 3.2rem;font-size:1.1rem;font-weight:800;border-radius:999px;border:none;cursor:pointer;box-shadow:0 22px 65px rgba(175,45,.65);}
    @media(max-width:900px){
      .modal-body{grid-template-columns:1fr;padding:0 1.6rem 2rem;}
      .profile-avatar{position:relative;top:auto;right:auto;margin:1rem auto 0;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Coach Profile</h1>
    <p class="lead">Welcome back, <strong id="coachName">Coach</strong>.</p>

    <!-- MAIN PROFILE CARD -->
    <div class="card">
      <form id="profileForm" enctype="multipart/form-data">
        <div class="form-grid">
          <div><label>Full Name</label><input id="coachNameInput" required></div>
          <div><label>Email</label><input id="email" type="email"></div>
          <div><label>Phone</label><input id="phone"></"></div>
        </div>

        <div style="margin-top:1.8rem">
          <label>Bio</label>
          <textarea id="bio"></textarea>
        </div>

        <div style="margin-top:1.8rem">
          <label>Specializations</label>
          <div style="display:flex;gap:1rem;margin-bottom:.5rem;flex-wrap:wrap">
            <input type="text" id="newSpec" placeholder="Add specialization..." style="flex:1;min-width:220px">
            <button type="button" class="btn btn-primary" id="addSpecBtn">Add</button>
          </div>
          <div class="specializations-list" id="specList"></div>
        </div>

        <div class="form-grid" style="margin-top:2rem">
          <div><label>Profile Photo</label><div class="upload-zone" id="profileUpload">Drop or click</div></div>
          <div><label>Before Photo</label><div class="upload-zone" id="beforeUpload">Drop or click</div></div>
          <div><label>After Photo</label><div class="upload-zone" id="afterUpload">Drop or click</div></div>
          <div><label>Certification</label><div class="upload-zone" id="certUpload">Drop or click</div></div>
        </div>

        <div id="uploadsList"></div>

        <div class="footer-actions">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-ghost" id="viewProfileBtn">Preview Public Profile</button>
        </div>

        <div class="footer-actions" style="margin-top:1rem;">
          <button type="button" class="btn btn-ghost" id="dashboardBtn">View Visitor Dashboard</button>
          <button type="button" class="btn btn-ghost" id="manageCoachesBtn" style="display:none;">Manage Coaches (Admin)</button>
        </div>

        <div style="text-align:center;margin-top:1rem">
          <button class="btn btn-ghost" id="logoutBtn" type="button">Logout</button>
        </div>

        <div id="profileStatus" class="status-line"></div>
      </form>
    </div>

    <!-- CHANGE PASSWORD -->
    <div class="card">
      <h2 class="section-title">Change Password</h2>
      <p style="font-size:.9rem;color:var(--muted);margin-bottom:1rem;">Update your password.</p>
      <div class="form-grid">
        <div><label>Current Password</label><input id="currentPassword" type="password"></div>
        <div><label>New Password</label><input id="newPassword" type="password"></div>
        <div><label>Confirm New Password</label><input id="confirmPassword" type="password"></div>
      </div>
      <div class="footer-actions">
        <button type="button" class="btn btn-primary" id="changePasswordBtn">Update Password</button>
      </div>
      <div id="passwordStatus" class="status-line"></div>
    </div>
  </div>

  <!-- PUBLIC PROFILE MODAL -->
  <div id="publicProfileModal" aria-hidden="true">
    <div class="modal-shell">
      <button class="modal-close" id="closeModal">&times;</button>
      <div class="modal-header">
        <h2 id="modalName">Coach</h2>
        <p><a id="modalEmail" style="color:var(--red);font-weight:bold;"></a></p>
        <div class="profile-avatar"><img id="modalProfilePic" src="/public/images/earth_steak.png"></div>
      </div>
      <div class="modal-body">
        <div>
          <div class="bio-box" id="modalBio"></div>
          <div class="before-after" id="beforeAfterContainer"></div>
        </div>
        <div>
          <div class="specialization-box">
            <h3>I Specialize In</h3>
            <ul id="specializationList"></ul>
          </div>
          <div id="certificateContainer"></div>
        </div>
      </div>
      <button class="book-btn-fixed" id="bookCoachBtn">Book This Coach</button>
    </div>
  </div>

<script>
const API_BASE = '/public/webapi/';
let currentCoach = {};
let specializations = [];
const newFiles = new Map();
const pendingDeletes = new Set();

function setStatus(el,msg,ok=true){if(!el)return;el.textContent=msg||'';el.className='status-line '+(msg?(ok?'ok':'err'):'');}
function imgUrl(f){return f?('/uploads/'+f+'?v='+Date.now()):'/public/images/earth_steak.png';}

// SESSION CHECK
async function checkSession(){
  try{
    const res = await fetch(API_BASE+'login.php',{method:'GET',credentials:'include'});
    const data = await res.json();
    return data.success?data:null;
  }catch{ return null; }
}

// LOAD PROFILE
async function loadProfile(){
  const s = await checkSession();
  if(!s) return window.location.href='/public/webapi/login.html';

  const res = await fetch(API_BASE+'get_coach.php?username='+encodeURI(s.username),
    {method:'GET',credentials:'include'});
  const data = await res.json();
  if(!data.success) return alert('Failed: '+(data.message||''));

  currentCoach = data.coach;
  document.getElementById('coachName').textContent = (currentCoach.CoachName || currentCoach.Username || 'Coach');
  document.getElementById('coachNameInput').value=currentCoach.CoachName||'';
  document.getElementById('email').value=currentCoach.Email||'';
  document.getElementById('phone').value=currentCoach.Phone||'';
  document.getElementById('bio').value=currentCoach.Bio||'';

  // specializations
  specializations = Array.isArray(currentCoach.Specializations)
    ? [...currentCoach.Specializations]
    : (typeof currentCoach.Specializations==='string'
      ? currentCoach.Specializations.split(/[;,|]/).map(s=>s.trim()).filter(Boolean)
      : []);
  renderSpecializations();
  renderImages();

  const manage=document.getElementById('manageCoachesBtn');
  if(manage && (s.role||'').toLowerCase()==='admin') manage.style.display='inline-flex';
}

// SPECIALIZATIONS
function renderSpecializations(){
  const list=document.getElementById('specList');
  list.innerHTML='';
  specializations.forEach((s,i)=>{
    const tag=document.createElement('span');
    tag.textContent=s;
    tag.onclick=()=>{specializations.splice(i,1);renderSpecializations();};
    list.appendChild(tag);
  });
}

// EXISTING IMAGES
function renderImages(){
  const list=document.getElementById('uploadsList');list.innerHTML='';
  const files=currentCoach.Files||{};
  Object.keys(files).forEach(slot=>{
    const file=files[slot];
    if(!file) return;
    const div=document.createElement('div');
    div.className='preview-item';
    div.innerHTML=`
      <img src="${imgUrl(file)}" class="preview-img">
      <div class="preview-caption">${slot}</div>
      <button class="remove-btn" data-slot="${slot}">&times;</button>`;
    div.querySelector('.remove-btn').onclick=()=>{
      pendingDeletes.add(slot);div.remove();
    };
    list.appendChild(div);
  });
}

// UPLOAD
function setupUploader(zone,slot){
  const el=document.getElementById(zone);
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=()=>{ if(inp.files[0]){ newFiles.set(slot,inp.files[0]); pendingDeletes.delete(slot); previewTemp(slot,inp.files[0]); } };
  el.onclick=()=>inp.click();
}
function previewTemp(slot,file){
  const list=document.getElementById('uploadsList');
  const div=document.createElement('div');div.className='preview-item';
  const fr=new FileReader();
  fr.onload=e=>{
    div.innerHTML=`
      <img src="${e.target.result}" class="preview-img">
      <div class="preview-caption">${slot}</div>
      <button class="remove-btn" data-slot="${slot}">&times;</button>`;
    div.querySelector('.remove-btn').onclick=()=>{newFiles.delete(slot);div.remove();};
    list.appendChild(div);
  };
  fr.readAsDataURL(file);
}

// SAVE
async function handleProfileSave(e){
  e.preventDefault();
  setStatus(profileStatus,'Saving…');
  const fd=new FormData();
  fd.append('coachName',coachNameInput.value.trim());
  fd.append('email',email.value.trim());
  fd.append('phone',phone.value.trim());
  fd.append('bio',bio.value);
  fd.append('specializations',JSON.stringify(specializations));
  newFiles.forEach((f,s)=>fd.append(`files[${s}]`,f));
  pendingDeletes.forEach(s=>fd.append('deleteSlots[]',s));

  const res=await fetch(API_BASE+'update_coach.php',{method:'POST',credentials:'include',body:fd});
  const data=await res.json();
  if(!data.success){setStatus(profileStatus,data.message,false);return;}
  newFiles.clear();pendingDeletes.clear();
  await loadProfile();
  setStatus(profileStatus,'Updated!',true);
}

// MODAL
function openProfileModal(){
  if(!currentCoach)return;
  document.getElementById('modalName').textContent=(currentCoach.CoachName||currentCoach.Username||'Coach');
  const email=currentCoach.Email||'';const eEl=document.getElementById('modalEmail');
  eEl.textContent=email;eEl.href=email?`mailto:${email}`:'#';
  document.getElementById('modalProfilePic').src=imgUrl((currentCoach.Files||{}).Profile);
  const bioBox=document.getElementById('modalBio');bioBox.innerHTML='';
  (currentCoach.Bio||'').split(/\n+/).forEach(t=>{if(t.trim()){const p=document.createElement('p');p.textContent=t;bioBox.appendChild(p);}});
  const ba=document.getElementById('beforeAfterContainer');ba.innerHTML='';
  ['Before','After'].forEach(s=>{
    const file=(currentCoach.Files||{})[s];if(file){const w=document.createElement('div');w.className='ba-pair';const img=document.createElement('img');img.src=imgUrl(file);w.appendChild(img);ba.appendChild(w);}
  });
  const list=document.getElementById('specializationList');list.innerHTML='';
  specializations.forEach(s=>{const li=document.createElement('li');li.textContent=s;list.appendChild(li);});
  const cert=document.getElementById('certificateContainer');cert.innerHTML='';
  if((currentCoach.Files||{}).Certificate){const i=document.createElement('img');i.src=imgUrl(currentCoach.Files.Certificate);cert.appendChild(i);}
  document.getElementById('bookCoachBtn').onclick=()=>email&&window.location.href=`mailto:${email}`;
  document.getElementById('publicProfileModal').style.display='flex';
}
function closeProfileModal(){document.getElementById('publicProfileModal').style.display='none';}

// PASSWORD
async function handleChangePassword(){
  const st=document.getElementById('passwordStatus');
  setStatus(st,'Updating...');
  const res=await fetch(API_BASE+'change_password.php',{
    method:'POST',headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({currentPassword:currentPassword.value,newPassword:newPassword.value})
  });
  const data=await res.json();
  if(!data.success)return setStatus(st,data.message,false);
  setStatus(st,'Updated',true);
}

// LOGOUT
async function handleLogout(){await fetch(API_BASE+'logout.php',{method:'POST',credentials:'include'});location.href='/public/webapi/login.html';}

// INIT
document.addEventListener('DOMContentLoaded',()=>{
  setupUploader('profileUpload','Profile');
  setupUploader('beforeUpload','Before');
  setupUploader('afterUpload','After');
  setupUploader('certUpload','Certificate');
  addSpecBtn.onclick=()=>{const v=newSpec.value.trim();if(v&&!specializations.includes(v)){specializations.push(v);renderSpecializations();}newSpec.value='';};
  profileForm.onsubmit=handleProfileSave;
  viewProfileBtn.onclick=openProfileModal;
  closeModal.onclick=closeProfileModal;
  publicProfileModal.onclick=e=>{if(e.target===e.currentTarget)closeProfileModal();};
  changePasswordBtn.onclick=handleChangePassword;
  dashboardBtn.onclick=()=>location.href='/public/webapi/visitor_dashboard.html';
  manageCoachesBtn.onclick=()=>location.href='/public/webapi/manage_coaches.html';
  logoutBtn.onclick=handleLogout;
  loadProfile();
});
</script>
</body>
</html>
