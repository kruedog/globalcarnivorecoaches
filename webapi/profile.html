<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coach Profile • Global Carnivore Coaches</title>
<link rel="icon" type="image/png" href="/images/earth_steak.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/global.css">
<style>
/* Additional styles specific to profile page */
.specializations-list span{background:var(--accent-red);color:#fff;padding:.3rem .8rem;border-radius:18px;font-size:.85rem;font-weight:600;cursor:pointer}
.upload-zone{border:3px dashed var(--primary-blue);padding:2rem 1rem;text-align:center;border-radius:14px;cursor:pointer;font-weight:600;color:var(--primary-blue);background:#f3f5fa}
.upload-zone:hover{border-color:var(--accent-red);background:rgba(175,30,45,.08)}
.preview-item{position:relative;border-radius:16px;overflow:hidden;background:#000;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.preview-img{width:100%;height:210px;object-fit:cover}
.preview-caption{background:var(--primary-blue);color:#fff;padding:.5rem;text-align:center;font-size:.8rem;font-weight:700}
.remove-btn{position:absolute;top:8px;right:8px;background:var(--accent-red);color:#fff;width:30px;height:30px;border-radius:50%;border:none;cursor:pointer;font-size:1rem;line-height:1}
</style>
</head>

<body>
<div class="wrap">
  <h1>Coach Profile</h1>
  <p class="lead">Welcome back, <strong id="coachName">Coach</strong>.</p>

  <div class="card">
    <form id="profileForm">
      <div class="form-grid">
        <div><label>Full Name</label><input id="coachNameInput" required></div>
        <div><label>Email</label><input id="email" type="email"></required></div>
        <div><label>Phone</label><input id="phone"></div>
      </div>

      <div style="margin-top:1.5rem">
        <label>Bio</label><textarea id="bio"></textarea>
      </div>

      <div style="margin-top:1.8rem">
        <label>Specializations</label>
        <div style="display:flex;gap:.6rem;margin-bottom:.4rem;flex-wrap:wrap">
          <input id="newSpec" placeholder="Add specialization…" style="flex:1;min-width:200px">
          <button type="button" class="btn btn-primary" id="addSpecBtn">Add</button>
        </div>
        <div id="specList" class="specializations-list"></div>
      </div>

      <!-- NEW PASSWORD SECTION -->
      <div style="margin-top:1.8rem">
        <label>New Password</label>
        <input id="password" type="password" placeholder="Enter new password">
        <small style="color:#555;font-size:.8rem;">Leave blank if unchanged.</small>
      </div>

      <div class="form-grid" style="margin-top:2rem">
        <div><label>Profile Photo</label><div class="upload-zone" id="profileUpload">Upload or Drop</div></div>
        <div><label>Before Photo</label><div class="upload-zone" id="beforeUpload">Upload or Drop</div></div>
        <div><label>After Photo</label><div class="upload-zone" id="afterUpload">Upload or Drop</div></div>
        <div><label>Certification</label><div class="upload-zone" id="certUpload">Upload or Drop</div></div>
      </div>

      <div id="uploadsList"></div>

      <div class="footer-actions">
        <button type="submit" class="btn btn-primary" id="saveBtn">Save Changes</button>
        <button type="button" class="btn btn-secondary" id="viewProfileBtn">Preview Public Profile</button>
      </div>

      <!-- New Dashboard + Admin -->
      <div class="footer-actions" style="margin-top:1rem;">
        <button type="button" class="btn btn-primary" id="dashboardBtn">Visitors Analytics</button>
        <button type="button" class="btn btn-secondary" id="manageCoachesBtn" style="display:none;">Manage Coaches</button>
      </div>

      <div style="text-align:center;margin-top:1rem">
        <button class="btn btn-secondary" id="logoutBtn" type="button">Logout</button>
      </div>
    </form>
  </div>
</div>

<!-- PUBLIC PROFILE MODAL (unchanged) -->
<div id="publicProfileModal" style="display:none;">
  … (modal content unchanged) …
</div>

<script>
const API_BASE = '/webapi/';
let currentCoach = {};
let specializations = [];
const newFiles = new Map();
const pendingDeletes = new Set();

/* Utility */
function imgUrl(f){ return `/uploads/${f}?v=${Date.now()}`; }

/* Load Session + Coach Info */
async function loadProfile() {
  try {
    const sessionRes = await fetch(API_BASE + 'login.php', {
      method: 'GET',
      credentials: 'include',
      cache: 'no-store'
    });
    const session = await sessionRes.json();
    if (!session.success) throw new Error();

    document.getElementById('coachName').textContent = session.coachName;

    const coachRes = await fetch(`${API_BASE}get_coach.php?username=${session.username}`, {
      credentials: 'include'
    });
    const data = await coachRes.json();
    if (!data.success) throw new Error("Coach not found");

    currentCoach = data.coach;

    document.getElementById('coachNameInput').value = currentCoach.CoachName || '';
    document.getElementById('email').value = currentCoach.Email || '';
    document.getElementById('phone').value = currentCoach.Phone || '';
    document.getElementById('bio').value = currentCoach.Bio || '';

    specializations = Array.isArray(currentCoach.Specializations) ? [...currentCoach.Specializations] : [];
    renderSpecializations();
    renderImages();

    if ((session.role||'').toLowerCase() === 'admin') {
      const manageBtn = document.getElementById('manageCoachesBtn');
      if (manageBtn) manageBtn.style.display = 'inline-flex';
    }
  } catch(e) {
    window.location.href = '/index.html';
  }
}

/* Specializations */
function renderSpecializations() {
  const list = document.getElementById('specList');
  list.innerHTML = '';
  specializations.forEach((s,i)=>{
    const el=document.createElement('span');
    el.textContent=s;
    el.onclick=()=>{specializations.splice(i,1);renderSpecializations()};
    list.appendChild(el);
  });
}
document.getElementById('addSpecBtn').onclick = ()=>{
  const inp=document.getElementById('newSpec');
  const v=inp.value.trim();
  if(v && !specializations.includes(v)) {
    specializations.push(v);
    renderSpecializations();
  }
  inp.value='';
};

/* Uploaders */
function setupUploader(zoneId,slot){
  const zone=document.getElementById(zoneId);
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*';
  input.onchange=()=>{ if(input.files[0]){ newFiles.set(slot,input.files[0]); pendingDeletes.delete(slot); previewTemp(slot,input.files[0]); } };
  zone.onclick=()=> input.click();
}
['profile','before','after','cert'].forEach((p,i)=>{
  const slot=['Profile','Before','After','Certificate'][i];
  setupUploader(p+'Upload',slot);
});

function previewTemp(slot,file){
  const list=document.getElementById('uploadsList');
  const div=document.createElement('div');
  div.className='preview-item';
  const reader=new FileReader();
  reader.onload=e=>{
    div.innerHTML=`
      <img src="${e.target.result}" class="preview-img">
      <div class="preview-caption">${slot}</div>
      <button class="remove-btn" data-slot="${slot}">×</button>`;
    div.querySelector('.remove-btn').onclick=()=>{ newFiles.delete(slot);div.remove();}
    list.appendChild(div);
  };
  reader.readAsDataURL(file);
}

/* Save */
document.getElementById('profileForm').onsubmit = async (e)=>{
  e.preventDefault();
  const form=new FormData();
  form.append('username', currentCoach.Username);
  form.append('coachName', document.getElementById('coachNameInput').value.trim());
  form.append('email', document.getElementById('email').value.trim());
  form.append('phone', document.getElementById('phone').value.trim());
  form.append('bio', document.getElementById('bio').value);
  form.append('specializations', JSON.stringify(specializations));

  const newPass=document.getElementById('password').value.trim();
  if(newPass) form.append('newPassword', newPass);

  newFiles.forEach((f,s)=> form.append(`files[${s}]`,f));
  pendingDeletes.forEach(s=> form.append('DeleteFile', s));

  const r = await fetch(API_BASE+'update_coach.php',{method:'POST',body:form,credentials:'include'});
  const data = await r.json();
  if(!data.success){ alert(data.message); return; }

  newFiles.clear(); pendingDeletes.clear();
  alert("Saved!");
  loadProfile();
};

/* Dashboard Button */
const dashBtn=document.getElementById('dashboardBtn');
if(dashBtn) dashBtn.onclick=()=> window.location.href='/webapi/visitor_dashboard.html';

/* Manage Coaches Button */
const mBtn=document.getElementById('manageCoachesBtn');
if(mBtn) mBtn.onclick=()=> window.location.href='/webapi/manage_coaches.html';

/* Logout */
document.getElementById('logoutBtn').onclick=()=>{
  fetch(API_BASE+'logout.php',{credentials:'include'}).finally(()=>{
    localStorage.clear();
    window.location.href='/index.html';
  });
};

/* INIT */
loadProfile();
</script>

</body>
</html>
