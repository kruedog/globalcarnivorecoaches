<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coach Profile • Global Carnivore Coaches</title>

<link rel="icon" type="image/png" href="/images/earth_steak.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* Styling unchanged — keeping your card design */
:root { --white:#fff; --parch:#D0D2D5; --text:#192168; --blue:#192168; --red:#AF1E2D; --muted:#555;
 --shadow:0 12px 40px rgba(0,0,0,.22); --radius:14px; --glass:rgba(255,255,255,.75);}
*{box-sizing:border-box;margin:0;padding:0}
body{min-height:100vh;font-family:'Inter',sans-serif;background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,var(--parch) 40%,#B0B3BA 100%);color:var(--text);padding:2rem 1rem;line-height:1.6}
.wrap{max-width:1160px;margin:auto}
h1{font-family:'Cinzel',serif;font-size:2.7rem;color:var(--blue);text-align:center;margin-bottom:.4rem}
.lead{text-align:center;color:var(--muted);font-size:1.15rem;margin-bottom:2.4rem}
.card{background:var(--glass);backdrop-filter:blur(16px);padding:2.4rem;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:2rem;border:1px solid rgba(255,255,255,.4)}
label{font-weight:600;margin-bottom:.6rem;display:block;color:var(--blue)}
.form-grid{display:grid;gap:1.4rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
input,textarea{width:100%;padding:1rem 1.1rem;border:2px solid var(--blue);border-radius:var(--radius);background:#fff;font-size:1rem;transition:border .3s,box-shadow .3s}
input:focus,textarea:focus{border-color:var(--red);outline:none;box-shadow:0 0 0 4px rgba(175,30,45,.15)}
textarea{resize:vertical;min-height:140px}
.btn{padding:.9rem 2.4rem;font-weight:700;border:none;border-radius:999px;cursor:pointer;font-size:1rem;transition:all .3s;margin:.25rem .4rem;display:inline-block}
.btn-primary{background:var(--red);color:#fff;box-shadow:0 8px 25px rgba(175,30,45,.35)}
.btn-secondary{background:transparent;border:2px solid var(--blue);color:var(--blue)}
.upload-zone{border:3px dashed var(--blue);padding:2rem 1.4rem;text-align:center;cursor:pointer;border-radius:var(--radius);background:rgba(25,33,104,.05);transition:all .3s;font-weight:600;color:var(--blue);font-size:.95rem}
.preview-item{position:relative;overflow:hidden;border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.15);background:#000}
.preview-img{width:100%;height:220px;object-fit:cover}
.preview-caption{background:rgba(25,33,104,.88);color:#fff;padding:.8rem;font-weight:600;text-align:center;position:absolute;bottom:0;width:100%;font-size:.9rem}
.remove-btn{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;width:32px;height:32px;border-radius:50%;border:none;font-size:1.3rem;line-height:1;cursor:pointer;z-index:5}
.specializations-list{margin-top:.7rem;display:flex;flex-wrap:wrap;gap:.6rem}
.specializations-list span{background:var(--red);color:#fff;padding:.35rem .9rem;border-radius:20px;font-size:.9rem;font-weight:600;cursor:pointer}
.footer-actions{text-align:center;margin-top:2rem}
#publicProfileModal{position:fixed;inset:0;background:rgba(25,33,104,.97);backdrop-filter:blur(16px);display:none;align-items:center;justify-content:center;padding:2rem;z-index:9999}
.modal-shell{background:var(--glass);border:6px solid var(--red);border-radius:28px;max-width:1500px;width:100%;max-height:96vh;overflow:hidden;position:relative;box-shadow:0 40px 100px rgba(0,0,0,.6)}
.modal-close{position:absolute;top:1.8rem;right:2.5rem;font-size:3rem;color:#ddd;line-height:1;text-decoration:none}
.profile-avatar{position:absolute;top:2.2rem;right:5rem;width:220px;height:220px;border:8px solid var(--red);border-radius:50%;overflow:hidden;background:#000}
</style>
</head>

<body>
<div class="wrap">
  <h1>Coach Profile</h1>
  <p class="lead">Welcome back, <strong id="coachName">Coach</strong>.</p>

  <div class="card">
    <form id="profileForm" enctype="multipart/form-data">
      <div class="form-grid">
        <div><label>Full Name</label><input id="coachNameInput" required></div>
        <div><label>Email Address</label><input id="email"></div>
        <div><label>Phone</label><input id="phone"></div>
      </div>

      <div style="margin-top:1.8rem"><label>Bio</label><textarea id="bio"></textarea></div>

      <div style="margin-top:1.8rem">
        <label>Specializations</label>
        <input type="text" id="newSpec" placeholder="Add specialization...">
        <button type="button" class="btn btn-primary add-spec-btn" type="button">Add</button>
        <div class="specializations-list" id="specList"></div>
      </div>

      <div class="form-grid" style="margin-top:2rem">
        <div><label>Profile Photo</label><div class="upload-zone" id="profileUpload">Drop or click</div></div>
        <div><label>Before Photo</label><div class="upload-zone" id="beforeUpload">Drop or click</div></div>
        <div><label>After Photo</label><div class="upload-zone" id="afterUpload">Drop or click</div></div>
        <div><label>Certification</label><div class="upload-zone" id="certUpload">Drop or click</div></div>
      </div>

      <div id="uploadsList"></div>

      <div class="footer-actions">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" id="viewProfileBtn">Preview Public Profile</button>
      </div>
    </form>
  </div>
  <button class="btn" id="logoutBtn" style="background:transparent;color:var(--muted)">Logout</button>
</div>

<div id="publicProfileModal">
  <div class="modal-shell">
    <a href="#" class="modal-close" id="closeModal">×</a>
    <div class="modal-header">
      <h2 id="modalName"></h2>
      <div class="profile-avatar"><img id="modalProfilePic"></div>
      <p><a id="modalEmail"></a></p>
    </div>
    <div id="modalBio" class="bio-box"></div>
    <div id="beforeAfterContainer" class="before-after"></div>
    <ul id="specializationList"></ul>
    <div id="certificateContainer"></div>
  </div>
</div>

<script>
const API_BASE = window.location.origin + `/webapi/`;

let currentCoach={};
let specializations=[];
let pendingDeletes=new Set();
let newFiles=new Map();

function imgUrl(p){
  if(!p)return '';
  return '/' + p.replace(/^\/+/,'') + '?v='+Date.now();
}

async function loadProfile(){
  const u=localStorage.getItem('username');
  if(!u)return location.href='/webapi/login.html';
  const r=await fetch(API_BASE+'get_coach.php?username='+encodeURIComponent(u),{credentials:'include'});
  const data=await r.json();
  currentCoach=data.coach;

  document.getElementById('coachName').textContent=currentCoach.CoachName||currentCoach.Username;
  document.getElementById('coachNameInput').value=currentCoach.CoachName||'';
  document.getElementById('email').value=currentCoach.Email||'';
  document.getElementById('phone').value=currentCoach.Phone||'';
  document.getElementById('bio').value=currentCoach.Bio||'';

  specializations=currentCoach.Specializations||[];
  renderSpecializations();
  renderExistingImages();
}

function renderSpecializations(){
  const list=document.getElementById('specList');
  list.innerHTML='';
  specializations.forEach((s,i)=>{
    const el=document.createElement('span'); el.textContent=s;
    el.onclick=()=>{specializations.splice(i,1);renderSpecializations()}
    list.appendChild(el);
  });
}

function renderExistingImages(){
  const list=document.getElementById('uploadsList');
  list.innerHTML='';
  if(!currentCoach.Files)return;
  const labels={Profile:'Profile',Before:'Before',After:'After',Certificate:'Certificate'};
  Object.entries(currentCoach.Files).forEach(([t,f])=>{
    const div=document.createElement('div');
    div.className='preview-item';
    div.innerHTML=`<img src="${imgUrl(f)}" class="preview-img">
    <div class="preview-caption">${labels[t]}</div>
    <button class="remove-btn">×</button>`;
    div.querySelector('.remove-btn').onclick=()=>{
      div.remove(); pendingDeletes.add(t);
    };
    list.appendChild(div);
  });
}

document.querySelector('.add-spec-btn').onclick=()=>{
  const i=document.getElementById('newSpec');
  const v=i.value.trim();
  if(v&&!specializations.includes(v)){specializations.push(v);renderSpecializations();}
  i.value='';
};

['profile','before','after','cert'].forEach(base=>{
  const zone=document.getElementById(base+'Upload');
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
  const map={profile:'Profile',before:'Before',after:'After',cert:'Certificate'};
  const type=map[base];
  inp.onchange=()=>{if(inp.files[0]){newFiles.set(type,inp.files[0]); pendingDeletes.delete(type); previewNewFile(inp.files[0],type);}};
  zone.onclick=()=>inp.click();
  zone.ondragover=e=>{e.preventDefault();zone.classList.add('dragover')};
  zone.ondragleave=()=>zone.classList.remove('dragover');
  zone.ondrop=e=>{
    e.preventDefault(); zone.classList.remove('dragover');
    if(e.dataTransfer.files[0]){
      inp.files=e.dataTransfer.files;
      inp.dispatchEvent(new Event('change'));
    }
  }
});

function previewNewFile(file,type){
  const div=document.createElement('div');
  div.className='preview-item';
  const r=new FileReader();
  r.onload=e=>{
    div.innerHTML=`<img src="${e.target.result}" class="preview-img">
    <div class="preview-caption">${type}</div>
    <button class="remove-btn">×</button>`;
    div.querySelector('.remove-btn').onclick=()=>{div.remove();newFiles.delete(type)};
    document.getElementById('uploadsList').appendChild(div);
  }
  r.readAsDataURL(file);
}

document.getElementById('profileForm').onsubmit=async e=>{
  e.preventDefault();
  const u=localStorage.getItem('username');
  const form=new FormData();
  form.append('username',u);
  form.append('coachName',document.getElementById('coachNameInput').value.trim());
  form.append('email',document.getElementById('email').value.trim());
  form.append('phone',document.getElementById('phone').value.trim());
  form.append('bio',document.getElementById('bio').value);
  form.append('specializations',JSON.stringify(specializations));
  pendingDeletes.forEach(t=>{form.append('delete[]',t)});
  newFiles.forEach((file,t)=>{form.append(`files[${t}]`,file)});
  const r=await fetch(API_BASE+'update_coach.php',{method:'POST',body:form,credentials:'include'});
  const text=await r.text();
  let data; try{data=JSON.parse(text)}catch(err){
    console.error(text);
    return alert("Save error: invalid server JSON");
  }
  if(data.success){alert("Saved!"); pendingDeletes.clear(); newFiles.clear(); loadProfile();}
  else alert("Save error: "+data.message);
};

document.getElementById('viewProfileBtn').onclick=()=>{
  const m=document.getElementById('publicProfileModal');
  document.getElementById('modalName').textContent=currentCoach.CoachName;
  const email=document.getElementById('email').value.trim();
  document.getElementById('modalEmail').href='mailto:'+email;
  document.getElementById('modalEmail').textContent=email;
  document.getElementById('modalProfilePic').src=currentCoach.Files?.Profile?imgUrl(currentCoach.Files.Profile):'/images/earth_steak.png';
  document.getElementById('modalBio').textContent=currentCoach.Bio||'';
  const ba=document.getElementById('beforeAfterContainer'); ba.innerHTML='';
  ['Before','After'].forEach(t=>{if(currentCoach.Files?.[t]){const img=document.createElement('img');img.src=imgUrl(currentCoach.Files[t]);ba.appendChild(img)}});
  const sl=document.getElementById('specializationList'); sl.innerHTML='';
  (currentCoach.Specializations||[]).forEach(s=>{const li=document.createElement('li');li.textContent=s;sl.appendChild(li)});
  const cert=document.getElementById('certificateContainer'); cert.innerHTML='';
  if(currentCoach.Files?.Certificate){const img=document.createElement('img');img.src=imgUrl(currentCoach.Files.Certificate);cert.appendChild(img)}
  m.style.display='flex';
};

document.getElementById('closeModal').onclick=e=>{
  e.preventDefault();
  document.getElementById('publicProfileModal').style.display='none';
};

document.getElementById('logoutBtn').onclick=()=>{
  localStorage.clear(); fetch(API_BASE+'logout.php',{credentials:'include'})
    .finally(()=>location.href='/webapi/login.html');
};

loadProfile();
</script>
</body>
</html>
