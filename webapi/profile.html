<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Coach Profile • Global Carnivore Coaches</title>
  <link rel="icon" type="image/png" href="/images/earth_steak.png">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --white:#fff;
      --parch:#D0D2D5;
      --text:#192168;
      --blue:#192168;
      --red:#AF1E2D;
      --muted:#555;
      --shadow:0 12px 40px rgba(0,0,0,.22);
      --radius:16px;
      --glass:rgba(255,255,255,.75);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:'Inter',sans-serif;
      background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,var(--parch) 40%,#B0B3BA 100%);
      color:var(--text);
      padding:2rem 1rem;
      line-height:1.6;
    }
    .wrap{max-width:1160px;margin:auto}
    h1{
      font-family:'Cinzel',serif;
      font-size:2.6rem;
      color:var(--blue);
      text-align:center;
      margin-bottom:.4rem;
    }
    .lead{
      text-align:center;
      color:var(--muted);
      font-size:1.05rem;
      margin-bottom:2.5rem;
    }

    .card{
      background:var(--glass);
      backdrop-filter:blur(16px);
      padding:2.5rem;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-bottom:2rem;
      border:1px solid rgba(255,255,255,.4);
    }

    .form-grid{
      display:grid;
      gap:1.6rem;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }

    label{
      font-weight:600;
      margin-bottom:.6rem;
      display:block;
      color:var(--blue);
    }
    input,textarea{
      width:100%;
      padding:1rem 1.1rem;
      border:2px solid var(--blue);
      border-radius:var(--radius);
      background:#fff;
      font-size:1rem;
      transition:border .3s, box-shadow .3s;
    }
    input:focus, textarea:focus{
      border-color:var(--red);
      outline:none;
      box-shadow:0 0 0 4px rgba(175,30,45,.15);
    }
    textarea{
      resize:vertical;
      min-height:140px;
    }

    .btn{
      padding:.9rem 2.4rem;
      font-weight:700;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-size:1rem;
      transition:all .3s;
      margin:.25rem .4rem;
      display:inline-block;
    }
    .btn-primary{
      background:var(--red);
      color:#fff;
      box-shadow:0 8px 25px rgba(175,30,45,.35);
    }
    .btn-secondary{
      background:transparent;
      border:2px solid var(--blue);
      color:var(--blue);
    }
    .btn-primary:hover{
      background:#8b1624;
      transform:translateY(-2px);
    }
    .btn-secondary:hover{
      background:var(--blue);
      color:#fff;
    }

    .upload-zone{
      border:3px dashed var(--blue);
      padding:2rem 1.4rem;
      text-align:center;
      cursor:pointer;
      border-radius:var(--radius);
      background:rgba(25,33,104,.05);
      transition:all .3s;
      font-weight:600;
      color:var(--blue);
      font-size:.95rem;
    }
    .upload-zone:hover{
      border-color:var(--red);
      background:rgba(175,30,45,.08);
    }
    .upload-zone.dragover{
      background:rgba(175,30,45,.15);
      border-color:var(--red);
    }

    #uploadsList{
      margin-top:2rem;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:1.4rem;
    }
    .preview-item{
      position:relative;
      overflow:hidden;
      border-radius:var(--radius);
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      background:#000;
    }
    .preview-img{
      width:100%;
      height:220px;
      object-fit:cover;
    }
    .preview-caption{
      background:rgba(25,33,104,.88);
      color:#fff;
      padding:.8rem;
      font-weight:600;
      text-align:center;
      position:absolute;
      bottom:0;
      width:100%;
      font-size:.9rem;
    }
    .remove-btn{
      position:absolute;
      top:10px;
      right:10px;
      background:var(--red);
      color:#fff;
      width:32px;
      height:32px;
      border-radius:50%;
      border:none;
      font-size:1.3rem;
      line-height:1;
      cursor:pointer;
      z-index:5;
    }

    .specializations-list{
      margin-top:.7rem;
      display:flex;
      flex-wrap:wrap;
      gap:.6rem;
    }
    .specializations-list span{
      background:var(--red);
      color:#fff;
      padding:.35rem .9rem;
      border-radius:20px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    .add-spec-btn{
      padding:.6rem 1.4rem;
      font-size:.9rem;
    }

    .footer-actions{
      text-align:center;
      margin-top:3rem;
    }

    /* Status message */
    #statusMsg{
      margin-top:1rem;
      text-align:center;
      font-size:.95rem;
      color:var(--muted);
    }

    /* PUBLIC PROFILE MODAL (cinematic card) */
    #publicProfileModal{
      position:fixed;
      inset:0;
      background:rgba(25,33,104,.97);
      backdrop-filter:blur(16px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:2rem;
      z-index:9999;
    }
    #publicProfileModal.active{display:flex;}

    .modal-shell{
      background:var(--glass);
      border:6px solid var(--red);
      border-radius:28px;
      max-width:1500px;
      width:100%;
      max-height:96vh;
      overflow:hidden;
      position:relative;
      box-shadow:0 40px 100px rgba(0,0,0,.6);
      display:flex;
      flex-direction:column;
    }
    .modal-close{
      position:absolute;
      top:1.8rem;
      right:2.5rem;
      font-size:3rem;
      color:#ddd;
      text-decoration:none;
      z-index:10;
      transition:.3s;
      line-height:1;
    }
    .modal-close:hover{
      color:#fff;
      transform:scale(1.08);
    }

    .modal-header{
      position:relative;
      padding:2.5rem 4rem 0;
      text-align:left;
    }
    .modal-header h2{
      font-family:'Cinzel',serif;
      font-size:2.4rem;
      color:var(--red);
      margin-bottom:.3rem;
    }
    .modal-header p{
      color:var(--muted);
      font-size:1.1rem;
    }

    .profile-avatar{
      position:absolute;
      top:2.2rem;
      right:5rem;
      width:220px;
      height:220px;
      border:8px solid var(--red);
      overflow:hidden;
      box-shadow:0 25px 70px rgba(0,0,0,.65);
      border-radius:50%;
      background:#000;
    }
    .profile-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .modal-body{
      flex:1;
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:3.5rem;
      padding:0 4rem 2.5rem;
      align-items:flex-start;
      overflow-y:auto;
    }

    .left-column{
      display:flex;
      flex-direction:column;
      gap:1.8rem;
    }

    .bio-box{
      background:#fff;
      border:5px solid var(--red);
      border-radius:var(--radius);
      padding:2rem 2.5rem;
      max-height:420px;
      overflow-y:auto;
      box-shadow:inset 0 8px 25px rgba(175,45,.16);
      font-size:1rem;
      line-height:1.9;
    }

    .before-after{
      display:flex;
      gap:1.8rem;
      align-items:flex-start;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .ba-pair img{
      width:210px;
      height:300px;
      object-fit:cover;
      object-position:top;
      border-radius:18px;
      box-shadow:0 18px 55px rgba(0,0,0,.5);
      border:6px solid var(--red);
      background:#000;
    }

    .right-column{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:1.8rem;
      padding-top:7rem;
    }

    .specialization-box{
      background:#fff;
      border:4px solid var(--red);
      border-radius:var(--radius);
      padding:1rem 1.4rem;
      width:320px;
      max-width:100%;
      max-height:160px;
      overflow-y:auto;
      text-align:center;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }
    .specialization-box h3{
      margin:0 0 .5rem;
      font-family:'Cinzel',serif;
      font-size:1.3rem;
      color:var(--red);
    }
    .specialization-box ul{
      list-style:none;
      margin:0;
      padding:0;
    }
    .specialization-box li{
      margin:.25rem 0;
      font-weight:600;
      color:var(--blue);
      font-size:.95rem;
    }

    #certificateContainer{
      text-align:center;
    }
    #certificateContainer img{
      max-width:260px;
      border:4px solid var(--red);
      border-radius:12px;
      box-shadow:0 14px 45px rgba(0,0,0,.5);
      background:#000;
    }

    .book-btn-fixed{
      position:absolute;
      bottom:1.8rem;
      right:3.5rem;
      background:var(--red);
      color:#fff;
      padding:1rem 3.2rem;
      font-size:1.2rem;
      font-weight:800;
      border-radius:999px;
      border:none;
      cursor:pointer;
      box-shadow:0 22px 65px rgba(175,45,.65);
      transition:all .4s ease;
      z-index:20;
    }
    .book-btn-fixed:hover{
      background:#c41c2e;
      transform:translateY(-6px) scale(1.03);
      box-shadow:0 32px 85px rgba(175,45,.8);
    }

    @media (max-width:1000px){
      .modal-body{
        grid-template-columns:1fr;
        gap:2rem;
        padding:0 1.8rem 2.4rem;
      }
      .profile-avatar{
        top:1.8rem;
        right:auto;
        left:50%;
        transform:translateX(-50%);
        width:180px;
        height:180px;
      }
      .modal-header{
        text-align:center;
        padding-top:9rem;
      }
      .right-column{
        align-items:center;
        padding-top:1rem;
      }
      .specialization-box{
        width:90%;
      }
      .book-btn-fixed{
        position:relative;
        bottom:auto;
        right:auto;
        margin:1.5rem auto 1.8rem;
        display:block;
        text-align:center;
      }
    }

    @media (max-width:700px){
      .card{padding:1.7rem}
      h1{font-size:2.1rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Coach Profile</h1>
    <p class="lead">Welcome back, <strong id="coachName">Coach</strong>.</p>

    <div class="card">
      <form id="profileForm" enctype="multipart/form-data">
        <div class="form-grid">
          <div>
            <label for="coachNameInput">Full Name</label>
            <input id="coachNameInput" name="coachName" required placeholder="Your full name">
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" placeholder="+1 (555) 555-5555">
          </div>
        </div>

        <div style="margin-top:1.8rem">
          <label for="bio">Bio</label>
          <textarea id="bio" name="bio" rows="8" placeholder="Share your carnivore transformation story, approach, and coaching style..."></textarea>
        </div>

        <div style="margin-top:1.8rem">
          <label>Specializations</label>
          <div style="display:flex;gap:1rem;margin-bottom:.5rem;flex-wrap:wrap">
            <input type="text" id="newSpec" placeholder="Add specialization (click tag to remove)" style="flex:1;min-width:220px">
            <button type="button" class="btn btn-primary add-spec-btn">Add</button>
          </div>
          <div class="specializations-list" id="specList"></div>
        </div>

        <div class="form-grid" style="margin-top:2rem">
          <div>
            <label>Profile Photo</label>
            <div class="upload-zone" id="profileUpload">Drop or click to upload profile photo</div>
          </div>
          <div>
            <label>Before Photo</label>
            <div class="upload-zone" id="beforeUpload">Drop or click to upload “before” photo</div>
          </div>
          <div>
            <label>After Photo</label>
            <div class="upload-zone" id="afterUpload">Drop or click to upload “after” photo</div>
          </div>
          <div>
            <label>Certification</label>
            <div class="upload-zone" id="certUpload">Drop or click to upload certification</div>
          </div>
        </div>

        <div id="uploadsList"></div>

        <div class="footer-actions">
          <button type="submit" class="btn btn-primary" id="saveBtn">Save Changes</button>
          <button type="button" class="btn btn-secondary" id="viewProfileBtn">Preview Public Profile</button>
          <button type="button" class="btn btn-secondary" id="openPublicPageBtn">Open Public Card Page</button>
        </div>

        <div id="statusMsg"></div>
      </form>
    </div>

    <div style="text-align:center;margin-top:1rem">
      <button type="button" class="btn" id="logoutBtn" style="background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,.08);">
        Logout
      </button>
    </div>
  </div>

  <!-- PUBLIC PROFILE MODAL -->
  <div id="publicProfileModal">
    <div class="modal-shell">
      <a href="#" class="modal-close" id="modalCloseBtn">×</a>
      <div class="modal-header">
        <h2 id="modalName">Coach Name</h2>
        <p id="modalUsername"></p>
        <div class="profile-avatar" id="modalProfilePic">
          <img src="/images/earth_steak.png" alt="Coach profile photo">
        </div>
      </div>
      <div class="modal-body">
        <div class="left-column">
          <div class="bio-box" id="modalBio"></div>
          <div class="before-after" id="beforeAfterContainer"></div>
        </div>
        <div class="right-column">
          <div class="specialization-box">
            <h3>I Specialize In</h3>
            <ul id="specializationList"></ul>
          </div>
          <div id="certificateContainer"></div>
        </div>
      </div>
      <button class="book-btn-fixed" type="button">Book This Coach</button>
    </div>
  </div>

  <script>
    // API base (matches index.html behavior)
    const API_BASE = window.location.protocol === 'https:'
      ? `https://${window.location.hostname}:477/webapi`
      : `http://${window.location.hostname}:8080/webapi`;

    let currentCoach = {};
    let specializations = [];
    const pendingDeletes = new Set();
    const newFiles = new Map();

    const statusMsgEl = document.getElementById('statusMsg');

    function setStatus(msg, isError = false) {
      if (!statusMsgEl) return;
      statusMsgEl.textContent = msg || '';
      statusMsgEl.style.color = isError ? '#b00020' : 'var(--muted)';
    }

    // Normalize image paths: handles 'public/uploads/..', '/uploads/..', 'uploads/..', or just 'file.jpg'
    function imgUrl(p) {
      if (!p) return '';
      let path = String(p);

      // Strip 'public/' prefix if present
      path = path.replace(/^public\//, '');

      // If it doesn't start with 'uploads/', assume it's a bare filename
      if (!/^uploads\//.test(path)) {
        path = 'uploads/' + path.replace(/^\/+/, '');
      }

      // Ensure leading slash
      path = '/' + path.replace(/^\/+/, '');
      return `${path}?v=${Date.now()}`;
    }

    async function loadProfile() {
      const username = localStorage.getItem('username');
      if (!username) {
        return location.href = `${API_BASE}/login.html`;
      }

      setStatus('Loading profile...');

      try {
        const res = await fetch(`${API_BASE}/get_coach.php?username=${encodeURIComponent(username)}`, {
          credentials: 'include',
          cache: 'no-store'
        });

        const data = await res.json();

        if (!data.success || !data.coach) {
          alert('Session expired or coach not found. Please log in again.');
          return location.href = `${API_BASE}/login.html`;
        }

        currentCoach = data.coach;

        // Header greeting
        document.getElementById('coachName').textContent =
          currentCoach.CoachName || currentCoach.Username || 'Coach';

        // Form fields
        document.getElementById('coachNameInput').value = currentCoach.CoachName || '';
        document.getElementById('phone').value = currentCoach.Phone || '';
        document.getElementById('bio').value = currentCoach.Bio || '';

        // Specializations
        specializations = Array.isArray(currentCoach.Specializations)
          ? currentCoach.Specializations.slice()
          : [];
        renderSpecializations();

        // Images
        renderExistingImages();

        setStatus('Profile loaded.');
        setTimeout(() => setStatus(''), 2000);
      } catch (err) {
        console.error('Load error:', err);
        setStatus('Network error loading profile.', true);
      }
    }

    function renderExistingImages() {
      const list = document.getElementById('uploadsList');
      list.innerHTML = '';
      if (!currentCoach.Files) return;

      const labels = {
        Profile: 'Profile',
        Before: 'Before',
        After: 'After',
        Certificate: 'Certificate'
      };

      Object.entries(currentCoach.Files).forEach(([type, filename]) => {
        if (!filename) return;
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <img src="${imgUrl(filename)}" class="preview-img" alt="${type}">
          <div class="preview-caption">${labels[type] || type}</div>
          <button class="remove-btn" data-type="${type}" type="button">×</button>
        `;
        const btn = div.querySelector('.remove-btn');
        btn.onclick = () => {
          div.remove();
          pendingDeletes.add(type);
        };
        list.appendChild(div);
      });
    }

    function renderSpecializations() {
      const list = document.getElementById('specList');
      list.innerHTML = '';
      specializations.forEach((s, i) => {
        const span = document.createElement('span');
        span.textContent = s;
        span.title = 'Click to remove';
        span.onclick = () => {
          specializations.splice(i, 1);
          renderSpecializations();
        };
        list.appendChild(span);
      });
    }

    document.querySelector('.add-spec-btn').onclick = () => {
      const txt = document.getElementById('newSpec');
      const val = txt.value.trim();
      if (!val) return;
      if (!specializations.includes(val)) {
        specializations.push(val);
        renderSpecializations();
      }
      txt.value = '';
      txt.focus();
    };

    // Upload handling for Profile, Before, After, Certificate
    ['profile', 'before', 'after', 'cert'].forEach(base => {
      const zone = document.getElementById(base + 'Upload');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';

      const labelMap = { profile: 'Profile', before: 'Before', after: 'After', cert: 'Certificate' };
      const type = labelMap[base];

      input.onchange = () => {
        if (input.files && input.files[0]) {
          newFiles.set(type, input.files[0]);
          // Remove from pendingDeletes if user re-adds a type
          pendingDeletes.delete(type);
          previewNewFile(input.files[0], type);
        }
      };

      zone.onclick = () => input.click();
      zone.ondragover = e => {
        e.preventDefault();
        zone.classList.add('dragover');
      };
      zone.ondragleave = () => zone.classList.remove('dragover');
      zone.ondrop = e => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          input.files = e.dataTransfer.files;
          input.dispatchEvent(new Event('change'));
        }
      };
    });

    function previewNewFile(file, type) {
      const list = document.getElementById('uploadsList');
      const div = document.createElement('div');
      div.className = 'preview-item';

      const reader = new FileReader();
      reader.onload = e => {
        div.innerHTML = `
          <img src="${e.target.result}" class="preview-img" alt="${type}">
          <div class="preview-caption">${type} • ${file.name}</div>
          <button class="remove-btn" data-type="${type}" type="button">×</button>
        `;
        div.querySelector('.remove-btn').onclick = () => {
          div.remove();
          newFiles.delete(type);
        };
        list.appendChild(div);
      };
      reader.readAsDataURL(file);
    }

    // Save profile
    document.getElementById('profileForm').onsubmit = async e => {
      e.preventDefault();
      const username = localStorage.getItem('username');
      if (!username) return;

      const form = new FormData();
      form.append('username', username);
      form.append('coachName', document.getElementById('coachNameInput').value.trim());
      form.append('phone', document.getElementById('phone').value.trim());
      form.append('bio', document.getElementById('bio').value);
      form.append('specializations', JSON.stringify(specializations));

      pendingDeletes.forEach(t => form.append('delete[]', t));
      newFiles.forEach((file, t) => {
        form.append('files[]', file);
        form.append('imageType[]', t);
      });

      setStatus('Saving profile...');

      try {
        const res = await fetch(`${API_BASE}/update_coach.php`, {
          method: 'POST',
          body: form,
          credentials: 'include'
        });

        const data = await res.json();

        if (data.success) {
          alert('Profile saved.');
          pendingDeletes.clear();
          newFiles.clear();
          await loadProfile();
          setStatus('Changes saved.');
          setTimeout(() => setStatus(''), 2000);
        } else {
          console.error('Save error:', data);
          setStatus('Error: ' + (data.message || 'Unknown error'), true);
        }
      } catch (err) {
        console.error('Save failed:', err);
        setStatus('Save failed — server unreachable.', true);
      }
    };

    // Public Profile Modal preview
    document.getElementById('viewProfileBtn').onclick = () => {
      if (!currentCoach || !currentCoach.Username) return;

      const modal = document.getElementById('publicProfileModal');
      document.getElementById('modalName').textContent =
        currentCoach.CoachName || currentCoach.Username;
      document.getElementById('modalUsername').textContent = '@' + currentCoach.Username;

      const profileImg = document.querySelector('#modalProfilePic img');
      if (currentCoach.Files && currentCoach.Files.Profile) {
        profileImg.src = imgUrl(currentCoach.Files.Profile);
      } else {
        profileImg.src = '/images/earth_steak.png';
      }

      // Bio in modal
      const bioBox = document.getElementById('modalBio');
      bioBox.innerHTML = '';
      const bioText = currentCoach.Bio || '';
      if (bioText.trim()) {
        // Split into paragraphs on blank lines
        const parts = bioText.split(/\r?\n\r?\n/g).filter(p => p.trim());
        parts.forEach(p => {
          const para = document.createElement('p');
          para.textContent = p.replace(/\r?\n/g, ' ');
          bioBox.appendChild(para);
        });
      } else {
        const para = document.createElement('p');
        para.textContent = 'This coach has not added a bio yet.';
        bioBox.appendChild(para);
      }

      // Before / After
      const ba = document.getElementById('beforeAfterContainer');
      ba.innerHTML = '';
      ['Before', 'After'].forEach(t => {
        if (currentCoach.Files && currentCoach.Files[t]) {
          const div = document.createElement('div');
          div.className = 'ba-pair';
          const img = document.createElement('img');
          img.src = imgUrl(currentCoach.Files[t]);
          img.alt = t + ' photo';
          div.appendChild(img);
          ba.appendChild(div);
        }
      });

      // Specializations
      const slist = document.getElementById('specializationList');
      slist.innerHTML = '';
      if (Array.isArray(currentCoach.Specializations) && currentCoach.Specializations.length) {
        currentCoach.Specializations.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          slist.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No specializations listed yet.';
        slist.appendChild(li);
      }

      // Certificate
      const cert = document.getElementById('certificateContainer');
      cert.innerHTML = '';
      if (currentCoach.Files && currentCoach.Files.Certificate) {
        const img = document.createElement('img');
        img.src = imgUrl(currentCoach.Files.Certificate);
        img.alt = 'Coaching certificate';
        cert.appendChild(img);
      }

      modal.classList.add('active');
    };

    // Open real public card on index.html (uses coach-{username} hash)
    document.getElementById('openPublicPageBtn').onclick = () => {
      if (!currentCoach || !currentCoach.Username) return;
      const slug = String(currentCoach.Username).toLowerCase();
      // This matches index.html modal id: "coach-" + username.toLowerCase()
      const url = `/index.html#coach-${encodeURIComponent(slug)}`;
      window.open(url, '_blank');
    };

    // Close modal
    document.getElementById('modalCloseBtn').onclick = e => {
      e.preventDefault();
      document.getElementById('publicProfileModal').classList.remove('active');
    };
    document.getElementById('publicProfileModal').addEventListener('click', e => {
      if (e.target === e.currentTarget) {
        e.currentTarget.classList.remove('active');
      }
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('publicProfileModal').classList.remove('active');
      }
    });

    // Logout
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.clear();
      fetch(`${API_BASE}/logout.php`, { credentials: 'include' })
        .finally(() => {
          location.href = `${API_BASE}/login.html`;
        });
    };

    // Init
    loadProfile();
  </script>
</body>
</html>
