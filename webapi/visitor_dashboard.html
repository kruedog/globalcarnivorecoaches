<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Visitor Dashboard • Global Carnivore Coaches</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="/images/earth_steak.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --blue:#192168;
  --red:#AF1E2D;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:'Inter',sans-serif;
  background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,#D0D2D5 40%,#B0B3BA 100%);
  padding:1.8rem 1rem;
  color:#111;
}
.wrap{max-width:1160px;margin:0 auto;}
header{
  background:#111;
  border-radius:18px;
  padding:1.8rem;
  color:#fff;
  box-shadow:0 16px 40px rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1.2rem;
}
header h1{
  font-family:'Cinzel',serif;
  font-size:2rem;
  margin-bottom:.25rem;
}
.badge{
  display:inline-block;
  padding:.15rem .6rem;
  border-radius:999px;
  font-size:.75rem;
  background:rgba(255,255,255,.12);
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:1rem;
  margin:1.8rem 0;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:1.3rem;
  box-shadow:0 10px 26px rgba(0,0,0,.18);
  border:1px solid rgba(25,33,104,.12);
}
.card h2{
  font-size:1rem;
  margin-bottom:.4rem;
  color:var(--blue);
}
.big-num{
  font-size:2rem;
  font-weight:800;
  color:var(--red);
}
.small{
  font-size:.78rem;
  color:#666;
}
.coach-list{
  margin-top:.4rem;
  max-height:320px;
  overflow-y:auto;
  border-top:1px solid rgba(0,0,0,.1);
}
.coach-row{
  padding:.45rem 0;
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  border-bottom:1px solid rgba(0,0,0,.05);
}
.coach-row span:first-child{font-weight:600}
.status{
  margin-top:.6rem;
  font-size:.85rem;
  min-height:1rem;
}
.status.err{color:var(--red)}
.top-nav{
  margin-top:1rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:.85rem;
}
.top-nav a{
  color:var(--blue);
  text-decoration:underline;
}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Visitor Dashboard</h1>
      <p>Visitor stats & Coach list (visible to logged-in coaches only).</p>
      <span class="badge" id="userBadge"></span>
    </div>
    <div>
      <a href="/profile.html" style="color:#fff;text-decoration:underline;">← Back to Profile</a>
    </div>
  </header>

  <div class="top-nav">
    <div>Visitor data from <code>visits.json</code> & <code>activity_log.json</code></div>
  </div>

  <div class="cards">
    <div class="card">
      <h2>Today’s Visits</h2>
      <div class="big-num" id="statToday">–</div>
      <div class="small">Unique visits today.</div>
    </div>
    <div class="card">
      <h2>Last 7 Days</h2>
      <div class="big-num" id="statWeek">–</div>
      <div class="small">Visitors in the last week.</div>
    </div>
    <div class="card">
      <h2>All-Time Visits</h2>
      <div class="big-num" id="statTotal">–</div>
      <div class="small">Total recorded visits.</div>
    </div>
    <div class="card">
      <h2>Logins Today</h2>
      <div class="big-num" id="statLoginsToday">–</div>
      <div class="small">Coach logins today.</div>
    </div>
  </div>

  <div class="card">
    <h2>Recent Visitor Locations</h2>
    <div class="small">Approximate geo data</div>
    <div id="locationList" class="coach-list"></div>
  </div>

  <div class="card" style="margin-top:1.3rem;">
    <h2>All Coaches</h2>
    <div class="coach-list" id="coachList"></div>
    <div id="dashStatus" class="status"></div>
  </div>
</div>

<script>
const API_BASE = window.location.origin + '/webapi/';

// ===== CHECK LOGIN SESSION =====
async function ensureSession() {
  try {
    const res = await fetch(API_BASE + 'login.php', {
      method: 'GET',
      credentials: 'include',
      cache: 'no-store'
    });
    const data = await res.json();
    if (!data.success) {
      window.location.href = '/webapi/login.html';
      return null;
    }
    document.getElementById('userBadge').textContent =
      (data.username || 'coach') + ' • ' + (data.role || 'coach');
    return data;
  } catch (err) {
    window.location.href = '/webapi/login.html';
    return null;
  }
}

// ===== LOAD VISITOR STATS =====
async function loadStats() {
  try {
    const res = await fetch(API_BASE + 'webapi.php?action=get_stats', { cache:'no-store' });
    const data = await res.json();

    document.getElementById('statToday').textContent       = data.today ?? '0';
    document.getElementById('statWeek').textContent        = data.week ?? '0';
    document.getElementById('statTotal').textContent       = data.total ?? '0';
    document.getElementById('statLoginsToday').textContent = data.loginsToday ?? '0';

    const list = document.getElementById('locationList');
    list.innerHTML = '';
    const entries = Object.entries(data.locationCount || {}).sort((a,b)=>b[1]-a[1]);
    if (!entries.length) {
      list.innerHTML = '<div style="padding:.6rem 0;">No location data yet.</div>';
    } else {
      entries.forEach(([loc,count]) => {
        const row = document.createElement('div');
        row.className = 'coach-row';
        row.innerHTML = `<span>${loc || 'Unknown'}</span><span>${count}</span>`;
        list.appendChild(row);
      });
    }

  } catch (err) {
    console.error('Stats load error', err);
  }
}

// ===== LOAD COACH LIST =====
async function loadCoaches() {
  const statusEl = document.getElementById('dashStatus');
  statusEl.textContent = 'Loading coaches…';

  try {
    const res = await fetch(API_BASE + 'get_all_coaches.php', {
      method:'GET',
      cache:'no-store'
    });
    const data = await res.json();
    const list = document.getElementById('coachList');
    list.innerHTML = '';

    if (!data.success || !Array.isArray(data.coaches) || !data.coaches.length) {
      list.innerHTML = '<div style="padding:.6rem 0;">No coaches found.</div>';
      statusEl.textContent = '';
      return;
    }

    data.coaches.forEach(c => {
      const row = document.createElement('div');
      row.className = 'coach-row';
      row.innerHTML = `
        <span>${c.CoachName || c.Username || 'Coach'}</span>
        <span>${(c.Role || 'coach').toUpperCase()}</span>
      `;
      list.appendChild(row);
    });

    statusEl.textContent = '';

  } catch (err) {
    console.error('Coach list error', err);
    statusEl.textContent = 'Failed to load coaches.';
    statusEl.classList.add('err');
  }
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', async () => {
  const session = await ensureSession();
  if (!session) return;
  await loadStats();
  await loadCoaches();
});
</script>
</body>
</html>
