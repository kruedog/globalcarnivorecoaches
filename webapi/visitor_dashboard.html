<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Visitor Dashboard • Global Carnivore Coaches</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="/images/earth_steak.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --blue:#192168;
  --red:#AF1E2D;
  --bg:#f5f7fb;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:'Inter',sans-serif;
  background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,#D0D2D5 40%,#B0B3BA 100%);
  padding:1.8rem 1rem;
  color:#111;
}
.wrap{max-width:1160px;margin:0 auto;}
header{
  background:#111;
  border-radius:18px;
  padding:1.8rem;
  color:#fff;
  box-shadow:0 16px 40px rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1.2rem;
}
header h1{
  font-family:'Cinzel',serif;
  font-size:2rem;
}
header p{font-size:.9rem;opacity:.9;}
.badge{
  display:inline-block;
  padding:.15rem .6rem;
  border-radius:999px;
  font-size:.75rem;
  background:rgba(255,255,255,.12);
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:1rem;
  margin:1.8rem 0;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:1.3rem;
  box-shadow:0 10px 26px rgba(0,0,0,.18);
  border:1px solid rgba(25,33,104,.12);
}
.chart-wrap{margin-top:1.3rem;}
.chart-inner{position:relative;height:220px;}
.big-num{font-size:2rem;font-weight:800;color:var(--red);}
.small{font-size:.78rem;color:#666;}
#updateTime{
  font-size:.8rem;
  opacity:.9;
  margin-top:.4rem;
}
#refreshStatus{
  margin-top:.3rem;
  font-size:.85rem;
  color:var(--blue);
  font-weight:600;
  opacity:0;
  transition:opacity .25s;
}
#refreshStatus.show{opacity:1;}
.locations-list{
  margin-top:.6rem;
  max-height:350px;
  overflow-y:auto;
  border-top:1px solid rgba(0,0,0,.1);
}
.location-row{
  padding:.45rem 0;
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  border-bottom:1px solid rgba(0,0,0,.04);
}
.status.err{color:var(--red);}
.cols{display:flex;gap:1rem;flex-wrap:wrap;}
.leader-list .leader-row{
  display:flex;justify-content:space-between;
  padding:.4rem 0;font-size:.88rem;
  border-bottom:1px solid rgba(0,0,0,.06);
}
</style>
</head>

<body>
<div class="wrap">
<header>
  <div>
    <h1>Visitor Dashboard</h1>
    <p>Live analytics — visible only to logged-in coaches.</p>
    <span class="badge" id="userBadge"></span>
    <div id="updateTime"></div>
    <div id="refreshStatus">Refreshing…</div>
  </div>
  <div><a href="/profile.html" style="color:#fff;text-decoration:underline;">← Back to Profile</a></div>
</header>

<!-- Summary cards -->
<div class="cards">
  <div class="card">
    <h2>Today’s Visits</h2>
    <div class="big-num" id="statToday">–</div>
  </div>
  <div class="card">
    <h2>Last 7 Days</h2>
    <div class="big-num" id="statWeek">–</div>
  </div>
  <div class="card">
    <h2>All-Time Visits</h2>
    <div class="big-num" id="statTotal">–</div>
  </div>
  <div class="card">
    <h2>All-Time Profile Views</h2>
    <div class="big-num" id="statProfileTotal">–</div>
  </div>
</div>

<!-- Visits chart -->
<div class="card chart-wrap">
  <h2>Visitor Activity — Last 14 Days</h2>
  <div class="small">Based on track_visit.php events</div>
  <div class="chart-inner"><canvas id="visitsChart"></canvas></div>
</div>

<!-- Profile views -->
<div class="card chart-wrap">
  <h2>Profile Views — Last 14 Days</h2>
  <div class="small">Public & coach view events</div>
  <div class="chart-inner"><canvas id="profileChart"></canvas></div>
</div>

<!-- Top coaches -->
<div class="card" style="margin-top:1.3rem;">
  <h2>Top Coaches (Total Views)</h2>
  <div class="leader-list" id="leaderList"></div>
</div>

<!-- Locations -->
<div class="card" style="margin-top:1.3rem;">
  <h2>Visitor Locations</h2>
  <div class="small">Geo approximations from visits.json</div>
  <div class="locations-list" id="locationList"></div>
  <div id="dashStatus" class="status"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_BASE = window.location.origin + '/webapi/';
const DASH_API = API_BASE + 'dashboard/';
let visitsChartObj = null;
let profileChartObj = null;

async function ensureSession(){
  try{
    const res = await fetch(API_BASE + 'login.php',{credentials:'include'});
    const data = await res.json();
    if(!data.success){
      window.location.href='/webapi/login.html';
      return null;
    }
    document.getElementById('userBadge').textContent = (data.username||'coach');
    return data;
  }catch(err){
    window.location.href='/webapi/login.html';
    return null;
  }
}

function showRefresh(){
  const rs=document.getElementById('refreshStatus');
  rs.classList.add('show');
  setTimeout(()=>rs.classList.remove('show'),1500);
}

function updateTimestamp(){
  const now=new Date();
  document.getElementById('updateTime')
    .textContent = 'Last updated: ' +
    now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

// VISIT STATS
async function loadStats(){
  showRefresh();
  try{
    const res=await fetch(API_BASE+'webapi.php?action=get_stats',{credentials:'include'});
    const data=await res.json();
    document.getElementById('statToday').textContent = data.today ?? 0;
    document.getElementById('statWeek').textContent  = data.week ?? 0;
    document.getElementById('statTotal').textContent = data.total ?? 0;

    const list=document.getElementById('locationList');
    list.innerHTML='';
    for(const [loc,count] of Object.entries(data.locationCount || {}).sort((a,b)=>b[1]-a[1])){
      const row=document.createElement('div');
      row.className='location-row';
      row.innerHTML=`<span>${loc||'Unknown'}</span><span>${count}</span>`;
      list.appendChild(row);
    }
    updateTimestamp();
  }catch(err){
    document.getElementById('dashStatus').textContent='Analytics unavailable.';
  }
}

// VISITS CHART
async function loadVisitChart(){
  try{
    const res=await fetch(API_BASE+'webapi.php?action=get_visits_14days',{credentials:'include'});
    const data=await res.json();
    if(!Array.isArray(data.points))return;
    const labels=data.points.map(p=>p.date);
    const counts=data.points.map(p=>p.count);
    const ctx=document.getElementById('visitsChart').getContext('2d');
    const gradient=ctx.createLinearGradient(0,0,0,220);
    gradient.addColorStop(0,'rgba(175,30,45,0.45)');
    gradient.addColorStop(1,'rgba(25,33,104,0.05)');
    if(visitsChartObj) visitsChartObj.destroy();
    visitsChartObj=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{data:counts,borderColor:'var(--red)',backgroundColor:gradient,fill:true,tension:0.35}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
    });
  }catch(err){}
}

// PROFILE DATA + CHART
async function loadProfileViews(){
  try{
    const res=await fetch(DASH_API+'get_profile_views.php',{credentials:'include'});
    const data=await res.json();
    if(!data.success) return;

    document.getElementById('statProfileTotal').textContent = data.total_views ?? 0;

    // History to 14-day aggregate
    const now=new Date();
    let dayMap={};
    for(let i=13;i>=0;i--){
      let d=new Date(now);
      d.setDate(d.getDate()-i);
      dayMap[d.toISOString().split('T')[0]]=0;
    }
    (data.history||[]).forEach(r=>{
      if(dayMap[r.date]!==undefined) dayMap[r.date]+=r.views;
    });
    const labels=Object.keys(dayMap);
    const views=Object.values(dayMap);

    const ctx=document.getElementById('profileChart').getContext('2d');
    const grad=ctx.createLinearGradient(0,0,0,220);
    grad.addColorStop(0,'rgba(25,33,104,0.45)');
    grad.addColorStop(1,'rgba(175,30,45,0.05)');
    if(profileChartObj) profileChartObj.destroy();
    profileChartObj=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{data:views,borderColor:'var(--blue)',backgroundColor:grad,fill:true,tension:0.35}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
    });

    const leaders=document.getElementById('leaderList');
    leaders.innerHTML=(Object.entries(data.totals_per_coach||{})
      .sort((a,b)=>b[1]-a[1])
      .slice(0,5)
      .map(([name,count])=>`<div class="leader-row"><span>${name}</span><span>${count}</span></div>`)
      .join('')) || '<div>No data yet</div>';

  }catch(err){}
}

// INIT
document.addEventListener('DOMContentLoaded', async ()=>{
  const ses=await ensureSession();
  if(!ses)return;
  await loadStats();
  await loadVisitChart();
  await loadProfileViews();

  // AUTO REFRESH every 60s
  setInterval(async ()=>{
    showRefresh();
    await loadStats();
    await loadVisitChart();
    await loadProfileViews();
    updateTimestamp();
  },60000);
});
</script>
</body>
</html>
