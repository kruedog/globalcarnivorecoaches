<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Visitor Dashboard • Global Carnivore Coaches</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="/images/earth_steak.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --blue:#192168;
  --red:#AF1E2D;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:'Inter',sans-serif;
  background:radial-gradient(circle at 10% 10%,#F8F9FA 0%,#D0D2D5 40%,#B0B3BA 100%);
  padding:1.8rem 1rem;
  color:#111;
}
.wrap{max-width:1160px;margin:0 auto;}
header{
  background:#111;
  border-radius:18px;
  padding:1.8rem;
  color:#fff;
  box-shadow:0 16px 40px rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
header h1{
  font-family:'Cinzel',serif;
  font-size:2rem;
}
header p{
  font-size:.9rem;
  opacity:.9;
}
.badge{
  display:inline-block;
  padding:.15rem .6rem;
  border-radius:999px;
  font-size:.75rem;
  background:rgba(255,255,255,.12);
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:1rem;
  margin:1.8rem 0;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:1.3rem;
  box-shadow:0 10px 26px rgba(0,0,0,.18);
  border:1px solid rgba(25,33,104,.12);
}
.card h2{
  font-size:1rem;
  margin-bottom:.4rem;
  color:var(--blue);
}
.big-num{
  font-size:2rem;
  font-weight:800;
  color:var(--red);
}
.small{
  font-size:.78rem;
  color:#666;
}
.locations-list{
  margin-top:.6rem;
  max-height:350px;
  overflow-y:auto;
  border-top:1px solid rgba(0,0,0,.1);
}
.location-row{
  padding:.45rem 0;
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  border-bottom:1px solid rgba(0,0,0,.04);
}
.location-row span:first-child{font-weight:600;}
.status{margin-top:.6rem;font-size:.85rem;min-height:1rem;}
.status.err{color:var(--red);}
.chart-wrap{
  margin-top:1.3rem;
}
.chart-inner{
  position:relative;
  height:220px;
}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Visitor Dashboard</h1>
      <p>Visitor analytics — visible only to logged-in coaches.</p>
      <span class="badge" id="userBadge"></span>
    </div>
    <div>
      <a href="/profile.html" style="color:#fff;text-decoration:underline;">← Back to Profile</a>
    </div>
  </header>

  <!-- Summary cards -->
  <div class="cards">
    <div class="card">
      <h2>Today’s Visits</h2>
      <div class="big-num" id="statToday">–</div>
    </div>
    <div class="card">
      <h2>Last 7 Days</h2>
      <div class="big-num" id="statWeek">–</div>
    </div>
    <div class="card">
      <h2>All-Time Visits</h2>
      <div class="big-num" id="statTotal">–</div>
    </div>
  </div>

  <!-- 14-day chart -->
  <div class="card chart-wrap">
    <h2>Visitor Activity — Last 14 Days</h2>
    <div class="small">Based on real visit events recorded by track_visit.php</div>
    <div class="chart-inner">
      <canvas id="visitsChart"></canvas>
    </div>
  </div>

  <!-- Locations -->
  <div class="card" style="margin-top:1.3rem;">
    <h2>Visitor Locations</h2>
    <div class="small">Geo approximations from visits.json</div>
    <div class="locations-list" id="locationList"></div>
    <div id="dashStatus" class="status"></div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const API_BASE = window.location.origin + '/webapi/';

// — Session Check —
async function ensureSession() {
  try {
    const res = await fetch(API_BASE + 'login.php', {
      method: 'GET',
      credentials: 'include',
      cache: 'no-store'
    });
    const data = await res.json();
    if (!data.success) {
      window.location.href = '/webapi/login.html';
      return null;
    }
    document.getElementById('userBadge').textContent =
      `${data.username || 'coach'} • ${data.role || 'coach'}`;
    return data;
  } catch {
    window.location.href = '/webapi/login.html';
    return null;
  }
}

// — Load Summary Stats + Locations —
async function loadStats() {
  const statusEl = document.getElementById('dashStatus');
  statusEl.textContent = 'Loading visitor analytics…';

  try {
    const res = await fetch(API_BASE + 'webapi.php?action=get_stats', {
      credentials: 'include',
      cache: 'no-store'
    });
    const data = await res.json();

    if (!data.success) {
      statusEl.textContent = data.message || 'Failed to load stats.';
      statusEl.classList.add('err');
      return;
    }

    document.getElementById('statToday').textContent = data.today ?? '0';
    document.getElementById('statWeek').textContent  = data.week ?? '0';
    document.getElementById('statTotal').textContent = data.total ?? '0';

    const list = document.getElementById('locationList');
    list.innerHTML = '';

    const entries = Object.entries(data.locationCount || {}).sort((a,b)=>b[1]-a[1]);
    if (!entries.length) {
      list.innerHTML = '<div style="padding:.6rem 0;">No location data yet.</div>';
    } else {
      entries.forEach(([loc,count]) => {
        const row = document.createElement('div');
        row.className = 'location-row';
        row.innerHTML = `<span>${loc || 'Unknown'}</span><span>${count}</span>`;
        list.appendChild(row);
      });
    }

    statusEl.textContent = '';

  } catch (err) {
    console.error('Stats error', err);
    statusEl.textContent = 'Analytics unavailable.';
    statusEl.classList.add('err');
  }
}

// — Load 14-day Visit Chart —
async function loadVisitChart() {
  try {
    const res = await fetch(API_BASE + 'webapi.php?action=get_visits_14days', {
      credentials: 'include',
      cache: 'no-store'
    });
    const data = await res.json();

    if (!data.success || !Array.isArray(data.points)) {
      return;
    }

    const labels = data.points.map(p => p.date);
    const counts = data.points.map(p => p.count);

    const ctx = document.getElementById('visitsChart').getContext('2d');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Visits',
          data: counts,
          borderWidth: 3,
          tension: 0.35,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        }
      }
    });

  } catch (err) {
    console.error('Chart load error', err);
  }
}

// — INIT —
document.addEventListener('DOMContentLoaded', async () => {
  const session = await ensureSession();
  if (!session) return;
  await loadStats();
  await loadVisitChart();
});
</script>
</body>
</html>
